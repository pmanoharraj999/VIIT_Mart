<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIIT Mart - Student E-commerce Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            // Dark mode removed
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            transition: background-color 0.3s ease;
        }

        /* Black & Silver Theme Variables */
        /* Light Mode (Default) */
        :root {
            --bg-primary: #e5e7eb;
            --bg-secondary: #f3f4f6;
            --text-primary: #000000;
            --text-secondary: #1f2937;
            --border-color: #000000;
            --card-bg: #e5e7eb;
            --accent-silver: #6b7280;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .bg-primary {
            background-color: var(--bg-primary);
        }

        .bg-secondary {
            background-color: var(--bg-secondary);
        }

        .text-primary {
            color: var(--text-primary);
        }

        .text-secondary {
            color: var(--text-secondary);
        }

        .border-color {
            border-color: var(--border-color);
        }

        .card-bg {
            background-color: var(--card-bg);
        }

        .gradient-bg {
            background: repeating-linear-gradient(45deg,
                    #1a1a1a,
                    #1a1a1a 10px,
                    #222222 10px,
                    #222222 20px);
        }

        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(102, 126, 234, 0.2);
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 3% auto;
            padding: 30px;
            border-radius: 30px;
            width: 90%;
            max-width: 600px;
            animation: slideDown 0.3s ease;
            color: var(--text-primary);
            border: 2px solid black;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .btn-primary {
            background: #000000;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        body.dark-mode .btn-primary {
            background: linear-gradient(135deg, #9ca3af 0%, #4b5563 100%);
            color: #ffffff;
            border: 1px solid #4b5563;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        .product-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            animation: slideInRight 0.3s ease;
        }

        .toast.error {
            background: #ef4444;
        }

        .toast.info {
            background: #3b82f6;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
            }

            to {
                transform: translateX(0);
            }
        }

        .category-chip {
            display: inline-block;
            padding: 8px 16px;
            background: white;
            border-radius: 20px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid black;
        }

        body.dark-mode .category-chip {
            background: #374151;
            color: #f9fafb;
            border: 1px solid #4b5563;
        }

        .category-chip:hover,
        .category-chip.active {
            background: black;
            color: white;
            transform: scale(1.05);
            border-color: black;
        }

        body.dark-mode .category-chip:hover,
        body.dark-mode .category-chip.active {
            background: #e5e7eb;
            color: black;
            border-color: #e5e7eb;
        }

        .role-card {
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--card-bg);
            border-radius: 20px;
        }

        .role-card:hover {
            border-color: #000000;
            transform: scale(1.05);
        }

        .role-card.selected {
            border-color: #000000;
            background: #f3f4f6;
        }

        body.dark-mode .role-card.selected {
            background: #374151;
        }

        .image-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-upload-area:hover {
            border-color: #000000;
            background: #f9fafb;
        }

        body.dark-mode .image-upload-area {
            border-color: #4b5563;
        }

        body.dark-mode .image-upload-area:hover {
            background: #374151;
        }

        .image-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .image-preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }

        .required::after {
            content: " *";
            color: red;
        }

        /* Admin/Buyer Restrictions */
        .role-buyer .admin-only,
        .role-admin .sell-only,
        .role-admin #heroSection,
        .role-admin #featuresSection,
        .role-admin #categoriesSection,
        .role-admin #productsSection,
        .role-admin .footer-hide-admin {
            display: none !important;
        }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 10px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            min-width: 250px;
            display: none;
            z-index: 1000;
            border: 1px solid var(--border-color);
        }

        .dropdown-menu.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .dropdown-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #f3f4f6;
        }

        body.dark-mode .dropdown-item:hover {
            background: #374151;
        }

        /* Notification Panel */
        .notification-panel {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 10px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 350px;
            max-height: 500px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            border: 1px solid var(--border-color);
        }

        .notification-panel.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .notification-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .notification-item:hover {
            background: #f3f4f6;
        }

        body.dark-mode .notification-item:hover {
            background: #374151;
        }

        .notification-item.unread {
            background: #eff6ff;
        }

        body.dark-mode .notification-item.unread {
            background: #1e3a5f;
        }

        /* Dark Mode Toggle */
        .dark-mode-toggle {
            width: 60px;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid black;
        }

        body.dark-mode .dark-mode-toggle {
            background: #667eea;
        }

        .dark-mode-toggle::before {
            content: '‚òÄÔ∏è';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
        }

        body.dark-mode .dark-mode-toggle::before {
            content: 'üåô';
            transform: translateX(30px);
        }

        /* Input Styles */
        input,
        select,
        textarea {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #000000;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        }

        /* 3D Floating Animation */
        @keyframes float {
            0% {
                transform: translateY(0px) rotate(0deg);
            }

            50% {
                transform: translateY(-20px) rotate(2deg);
            }

            100% {
                transform: translateY(0px) rotate(0deg);
            }
        }

        .float-animation {
            animation: float 6s ease-in-out infinite;
        }

        .hero-3d-img {
            max-width: 100%;
            height: auto;
            filter: drop-shadow(0 20px 50px rgba(0, 0, 0, 0.5));
            border-radius: 30px;
        }

        /* Order Status Badge */
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-seller-contacted {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-seller-delivered-to-admin {
            background: #e0e7ff;
            color: #3730a3;
        }

        .status-buyer-notified {
            background: #fce7f3;
            color: #831843;
        }

        .status-completed {
            background: #d1fae5;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        #mainNavbar {
            background-image: url('header_bg.png');
            background-repeat: repeat;
        }
    </style>
</head>

<body class="bg-primary text-primary">

    <!-- Navigation Bar -->
    <nav id="mainNavbar" class="shadow-lg sticky top-0 z-50 card-bg border-b-4 border-gray-300">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center gap-3 cursor-pointer border-2 border-black rounded-xl px-3 py-1 bg-gray-300 hover:bg-gray-400 transition"
                    onclick="handleLogoClick()">
                    <div class="text-3xl">üéì</div>
                    <span class="text-2xl font-bold text-black ">
                        VIIT Mart
                    </span>
                </div>

                <!-- Search Bar -->
                <div id="topSearchBar" class="hidden md:flex flex-1 max-w-xl mx-8">
                    <div class="relative w-full">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="searchInput" placeholder="Search products, services, or sellers..."
                            class="w-full pl-10 pr-4 py-2 border-2 rounded-xl bg-gray-50 border-black text-gray-900 focus:border-black focus:outline-none   "
                            oninput="handleSearchInput(this.value)" autocomplete="off">
                        <!-- Search Suggestions -->
                        <div id="searchSuggestions"
                            class="absolute w-full mt-1 bg-white  rounded-xl shadow-xl border border-gray-200  hidden z-50 max-h-60 overflow-y-auto">
                        </div>
                    </div>
                </div>

                <!-- Right Side Icons -->
                <div class="flex items-center gap-6">
                    <!-- Dark Mode Toggle Removed -->

                    <div id="loggedOutNav" class="flex items-center gap-4">
                        <button onclick="openLoginModal()"
                            class="text-black border-2 border-black rounded-xl px-4 py-1.5 bg-gray-300 hover:bg-gray-400 transition font-medium">
                            <i class="fas fa-sign-in-alt mr-2"></i>Login
                        </button>
                        <button onclick="openRegisterModal()" class="btn-primary">
                            Sign Up
                        </button>
                    </div>

                    <div id="loggedInNav" class="hidden items-center gap-6">
                        <!-- Wishlist -->
                        <div id="navWishlist" class="relative cursor-pointer" onclick="openWishlist()">
                            <i class="far fa-heart text-2xl text-black hover:text-red-500 transition-colors "></i>
                            <span class="notification-badge" id="wishlistCount">0</span>
                        </div>

                        <!-- Notifications -->
                        <div id="navNotifications" class="relative">
                            <div class="cursor-pointer" onclick="toggleNotifications()">
                                <i class="fas fa-bell text-2xl text-black hover:text-gray-700  "></i>
                                <span class="notification-badge" id="notificationCount">0</span>
                            </div>

                            <!-- Notification Panel -->
                            <div id="notificationPanel" class="notification-panel">
                                <div class="p-4 border-b border-color">
                                    <h3 class="font-bold text-lg">Notifications</h3>
                                </div>
                                <div id="notificationList">
                                    <!-- Notifications will be dynamically added -->
                                </div>
                            </div>
                        </div>

                        <!-- Cart -->
                        <div id="navCart" class="relative cursor-pointer" onclick="openCart()">
                            <i class="fas fa-shopping-cart text-2xl text-black hover:text-gray-700  "></i>
                            <span class="notification-badge" id="cartCount">0</span>
                        </div>

                        <!-- User Menu -->
                        <div class="relative">
                            <div class="hidden md:flex items-center gap-3 cursor-pointer border-2 border-black rounded-xl px-3 py-1 bg-gray-300 hover:bg-gray-400 transition"
                                onclick="toggleUserMenu()">
                                <img id="userAvatar" src="" class="w-10 h-10 rounded-full border-2 border-black">
                                <div>
                                    <div class="font-semibold text-sm text-black" id="userName">User</div>
                                    <div class="text-xs text-gray-700" id="userRole">Student</div>
                                </div>
                                <i class="fas fa-chevron-down text-sm text-black"></i>
                            </div>

                            <!-- User Dropdown Menu -->
                            <div id="userMenu" class="dropdown-menu">
                                <div class="p-4 border-b border-color">
                                    <div class="font-bold text-primary" id="menuUserName">User</div>
                                    <div class="text-sm text-secondary" id="menuUserEmail">user@college.edu</div>
                                </div>
                                <div class="dropdown-item" onclick="openDashboard()">
                                    <i class="fas fa-tachometer-alt text-black "></i>
                                    <span>Dashboard</span>
                                </div>
                                <div id="menuMyOrders" class="dropdown-item" onclick="openMyOrders()">
                                    <i class="fas fa-shopping-bag text-blue-600"></i>
                                    <span>My Orders</span>
                                </div>
                                <div class="dropdown-item" id="menuMyProducts" onclick="openMyProducts()">
                                    <i class="fas fa-box text-green-600"></i>
                                    <span>My Products</span>
                                </div>
                                <div id="menuWishlist" class="dropdown-item" onclick="openWishlist()">
                                    <i class="fas fa-heart text-red-600"></i>
                                    <span>Wishlist</span>
                                </div>
                                <div class="dropdown-item" onclick="openSettings()">
                                    <i class="fas fa-cog text-gray-600"></i>
                                    <span>Settings</span>
                                </div>
                            </div>
                        </div>

                        <button id="navSellBtn" class="btn-primary sell-only hidden lg:block" onclick="openSellModal()">
                            + Sell Product
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section id="heroSection" class="gradient-bg text-white py-12">
        <div class="max-w-7xl mx-auto px-4">
            <div class="grid md:grid-cols-2 gap-12 items-center">
                <div>
                    <h1 class="text-5xl font-bold mb-6 leading-tight">
                        Buy & Sell Within Your <span class="text-yellow-300 ">Campus</span> üéì
                    </h1>
                    <p class="text-xl mb-8 text-white/90">
                        Your trusted student marketplace. Books, electronics, services, and more - all from verified
                        college students.
                    </p>

                    <div class="flex gap-4 mb-12">
                        <button onclick="scrollToProducts()"
                            class="bg-white text-black px-8 py-4 rounded-xl font-bold hover:scale-105 transition  ">
                            Browse Products
                        </button>
                        <button id="heroSellBtn"
                            class="sell-only border-2 border-white px-8 py-4 rounded-xl font-bold hover:bg-white hover:text-black transition    "
                            onclick="openSellModal()">
                            Start Selling
                        </button>
                    </div>


                </div>

                <div class="hidden md:block">
                    <img src="C:/Users/user/.gemini/antigravity/brain/2f4f11d0-8c77-47dc-9421-3c6903137192/hero_3d_composition_1766903008640.png"
                        alt="3D Ecommerce Illustration" class="hero-3d-img float-animation">
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section id="featuresSection" class="py-8 bg-white  border-b">
        <div class="max-w-7xl mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 text-center">
                <div class="p-6 border-2 border-black rounded-3xl bg-gray-50 hover:bg-white transition-all shadow-sm">
                    <img src="C:/Users/user/.gemini/antigravity/brain/2f4f11d0-8c77-47dc-9421-3c6903137192/buyer_3d_icon_1766903026669.png"
                        class="w-16 h-16 mx-auto mb-2 float-animation rounded-2xl border-2 border-black">
                    <h3 class="text-xl font-bold mb-2">Easy Buying</h3>
                    <p class="text-secondary text-sm">Secure campus transactions at your fingertips.</p>
                </div>
                <div class="p-6 border-2 border-black rounded-3xl bg-gray-50 hover:bg-white transition-all shadow-sm">
                    <img src="C:/Users/user/.gemini/antigravity/brain/2f4f11d0-8c77-47dc-9421-3c6903137192/seller_3d_icon_1766903072462.png"
                        class="w-16 h-16 mx-auto mb-2 float-animation rounded-2xl border-2 border-black"
                        style="animation-delay: 1s;">
                    <h3 class="text-xl font-bold mb-2">Simple Selling</h3>
                    <p class="text-secondary text-sm">List products in seconds and reach students.</p>
                </div>
                <div class="p-6 border-2 border-black rounded-3xl bg-gray-50 hover:bg-white transition-all shadow-sm">
                    <img src="C:/Users/user/.gemini/antigravity/brain/2f4f11d0-8c77-47dc-9421-3c6903137192/package_3d_icon_1766903238774.png"
                        class="w-16 h-16 mx-auto mb-2 float-animation rounded-2xl border-2 border-black"
                        style="animation-delay: 2s;">
                    <h3 class="text-xl font-bold mb-2">Campus Pick-up</h3>
                    <p class="text-secondary text-sm">No shipping needed. Meet and swap on campus.</p>
                </div>
                <div class="p-6 border-2 border-black rounded-3xl bg-gray-50 hover:bg-white transition-all shadow-sm">
                    <img src="C:/Users/user/.gemini/antigravity/brain/2f4f11d0-8c77-47dc-9421-3c6903137192/admin_3d_icon_1766903152044.png"
                        class="w-16 h-16 mx-auto mb-2 float-animation rounded-2xl border-2 border-black"
                        style="animation-delay: 3s;">
                    <h3 class="text-xl font-bold mb-2">Secure Portal</h3>
                    <p class="text-secondary text-sm">Admin-verified sellers for a safe community.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Admin Dashboard View (Home Page) -->
    <main id="adminDashboardLanding" class="max-w-7xl mx-auto px-4 py-8 hidden">
        <!-- Dashboard content will be rendered here for admins -->
    </main>

    <!-- Categories -->
    <section id="categoriesSection" class="py-4 shadow-sm card-bg border-b border-color">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <div class="flex flex-wrap justify-center">
                <span class="category-chip active" onclick="filterCategory('all', event)">üî• All</span>
                <span class="category-chip" onclick="filterCategory('electronics', event)">üíª Electronics</span>
                <span class="category-chip" onclick="filterCategory('books', event)">üìö Books & Notes</span>
                <span class="category-chip" onclick="filterCategory('fashion', event)">üëï Fashion</span>
                <span class="category-chip" onclick="filterCategory('furniture', event)">ü™ë Furniture</span>
                <span class="category-chip" onclick="filterCategory('services', event)">üõ†Ô∏è Services</span>
                <span class="category-chip" onclick="filterCategory('sports', event)">‚öΩ Sports</span>
            </div>
        </div>
    </section>

    <!-- Products Section -->
    <section class="max-w-7xl mx-auto px-4 py-12" id="productsSection">
        <div class="inline-flex items-center gap-2 mb-8 border-2 border-black rounded-xl p-2 px-4 bg-white shadow-sm">
            <i class="fas fa-fire text-xl text-orange-600"></i>
            <h2 class="text-xl font-bold text-primary">Trending on Campus</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6" id="products-container">
            <!-- Product Cards will be dynamically generated -->
        </div>
    </section>

    <!-- Footer -->
    <footer class="gradient-bg text-white py-8">
        <div class="max-w-7xl mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
                <div>
                    <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-3xl">üéì</span> VIIT Mart
                    </h3>
                    <p class="text-gray-400">Your trusted campus marketplace for buying and selling within college
                        community.</p>
                </div>

                <div id="footerQuickLinks" class="footer-hide-admin">
                    <h4 class="font-bold text-lg mb-4">Quick Links</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="#" onclick="scrollToHome(); return false;" class="hover:text-white">About Us</a>
                        </li>
                        <li><a href="#" onclick="openHowItWorksModal(); return false;" class="hover:text-white">How It
                                Works</a></li>
                        <li><a href="#" onclick="openSafetyTipsModal(); return false;" class="hover:text-white">Safety
                                Tips</a></li>
                        <li><a href="#" class="hover:text-white">Seller Academy</a></li>
                    </ul>
                </div>

                <div id="footerCategories" class="footer-hide-admin">
                    <h4 class="font-bold text-lg mb-4">Categories</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="#" onclick="filterFromFooter('electronics'); return false;"
                                class="hover:text-white">Electronics</a></li>
                        <li><a href="#" onclick="filterFromFooter('books'); return false;"
                                class="hover:text-white">Books & Notes</a></li>
                        <li><a href="#" onclick="filterFromFooter('services'); return false;"
                                class="hover:text-white">Services</a></li>
                        <li><a href="#" onclick="filterFromFooter('fashion'); return false;"
                                class="hover:text-white">Fashion</a></li>
                    </ul>
                </div>

                <div id="footerContact" class="footer-hide-admin">
                    <h4 class="font-bold text-lg mb-4">Contact</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><i class="fas fa-envelope mr-2"></i> support@viitmart.com</li>
                        <li><i class="fas fa-phone mr-2"></i> +91 98765 43210</li>
                    </ul>
                </div>
            </div>

            <div class="border-t border-gray-700 pt-6 text-center text-gray-400">
                <p>&copy; 2025 VIIT Mart. All rights reserved. | Made with ‚ù§Ô∏è by Students, for Students</p>
                <!-- Admin Portal Link Removed -->
            </div>
        </div>
    </footer>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üîê Login to CampusMart</h2>
                <button onclick="closeLoginModal()" class="text-2xl hover:text-red-500">&times;</button>
            </div>

            <!-- Role Selection for Login -->
            <div class="mb-6">
                <label class="block font-semibold mb-3">Login As:</label>
                <div class="grid grid-cols-2 gap-4">
                    <div class="role-card border-2 rounded-xl p-4 text-center"
                        onclick="selectLoginRole('buyer', event)">
                        <img src="C:/Users/user/.gemini/antigravity/brain/2f4f11d0-8c77-47dc-9421-3c6903137192/buyer_3d_icon_1766903026669.png"
                            class="w-16 h-16 mx-auto mb-2 rounded-2xl border-2 border-black">
                        <div class="font-bold text-sm">Buyer</div>
                    </div>
                    <div class="role-card border-2 rounded-xl p-4 text-center"
                        onclick="selectLoginRole('seller', event)">
                        <img src="C:/Users/user/.gemini/antigravity/brain/2f4f11d0-8c77-47dc-9421-3c6903137192/seller_3d_icon_1766903072462.png"
                            class="w-16 h-16 mx-auto mb-2 rounded-2xl border-2 border-black">
                        <div class="font-bold text-sm">Seller</div>
                    </div>
                </div>
                <input type="hidden" id="loginRole" required>
            </div>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <!-- Regular Login Fields -->
                <div id="regularLoginFields">
                    <div class="mb-4">
                        <label class="block font-semibold mb-2 required">Roll Number</label>
                        <input type="text" id="loginRollNumber" required
                            class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                            placeholder="e.g., 21CS001">
                    </div>

                    <div class="mb-4">
                        <label class="block font-semibold mb-2 required">Phone Number</label>
                        <input type="tel" id="loginPhone" required pattern="[0-9]{10}"
                            class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                            placeholder="10 digit mobile number">
                    </div>

                    <div class="mb-6 relative">
                        <label class="block font-semibold mb-2 required">Password</label>
                        <input type="password" id="loginPassword" required
                            class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                            placeholder="Enter your password">
                        <i class="fas fa-eye absolute right-4 top-10 cursor-pointer text-gray-500"
                            onclick="togglePassword('loginPassword', this)"></i>
                    </div>
                </div>

                <button type="submit" class="w-full btn-primary mb-4">
                    Login
                </button>

                <p class="text-center text-secondary">
                    Don't have an account?
                    <button type="button" onclick="closeLoginModal(); openRegisterModal();"
                        class="text-black  font-bold hover:underline">
                        Sign Up
                    </button>
                </p>
                <p class="text-center mt-2">
                    <button type="button" onclick="closeLoginModal(); openForgotPassword();"
                        class="text-sm text-gray-500 hover:text-black ">
                        Forgot Password?
                    </button>
                </p>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üìù Register on CampusMart</h2>
                <button onclick="closeRegisterModal()" class="text-2xl hover:text-red-500">&times;</button>
            </div>

            <!-- Role Selection -->
            <div class="mb-6">
                <label class="block font-semibold mb-3 required">Select Your Role</label>
                <div class="grid grid-cols-2 gap-4">
                    <div class="role-card border-2 rounded-xl p-4 text-center" onclick="selectRole('buyer', event)">
                        <img src="C:/Users/user/.gemini/antigravity/brain/2f4f11d0-8c77-47dc-9421-3c6903137192/buyer_3d_icon_1766903026669.png"
                            class="w-16 h-16 mx-auto mb-2 rounded-2xl border-2 border-black">
                        <div class="font-bold">Buyer</div>
                        <div class="text-xs text-secondary mt-1">Buy products</div>
                    </div>
                    <div class="role-card border-2 rounded-xl p-4 text-center" onclick="selectRole('seller', event)">
                        <img src="C:/Users/user/.gemini/antigravity/brain/2f4f11d0-8c77-47dc-9421-3c6903137192/seller_3d_icon_1766903072462.png"
                            class="w-16 h-16 mx-auto mb-2 rounded-2xl border-2 border-black">
                        <div class="font-bold">Seller</div>
                        <div class="text-xs text-secondary mt-1">Sell products</div>
                    </div>
                </div>
                <input type="hidden" id="selectedRole" required>
            </div>

            <!-- Admin Secret Code Field -->
            <div id="adminSecretRegField" class="mb-4 relative" style="display: none;">
                <label class="block font-semibold mb-2 required">Admin Secret Code</label>
                <input type="password" id="regAdminSecret"
                    class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                    placeholder="Enter admin secret code to register">
                <i class="fas fa-eye absolute right-4 top-10 cursor-pointer text-gray-500"
                    onclick="togglePassword('regAdminSecret', this)"></i>
                <p class="text-xs text-red-500 mt-1">‚ö†Ô∏è Only authorized admins have this code</p>
            </div>

            <form id="registerForm" onsubmit="handleRegister(event)">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block font-semibold mb-2 required">Full Name</label>
                        <input type="text" id="regName" required
                            class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                            placeholder="John Doe">
                    </div>

                    <div>
                        <label class="block font-semibold mb-2 required">Roll Number</label>
                        <input type="text" id="regRollNumber" required
                            class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                            placeholder="21CS001">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block font-semibold mb-2 required">Branch</label>
                        <select id="regBranch" required
                            class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none">
                            <option value="">Select Branch</option>
                            <option value="CSE">Computer Science (CSE)</option>
                            <option value="ECE">Electronics (ECE)</option>
                            <option value="EEE">Electrical (EEE)</option>
                            <option value="ME">Mechanical (ME)</option>
                            <option value="CE">Civil (CE)</option>
                            <option value="IT">Information Technology (IT)</option>
                            <option value="MBA">MBA</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div>
                        <label class="block font-semibold mb-2 required">Year</label>
                        <select id="regYear" required
                            class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none">
                            <option value="">Select Year</option>
                            <option value="1">1st Year</option>
                            <option value="2">2nd Year</option>
                            <option value="3">3rd Year</option>
                            <option value="4">4th Year</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block font-semibold mb-2 required">Phone Number</label>
                    <input type="tel" id="regPhone" required pattern="[0-9]{10}"
                        class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                        placeholder="9876543210">
                    <p class="text-xs text-secondary mt-1">10 digit mobile number</p>
                </div>

                <div class="mb-4">
                    <label class="block font-semibold mb-2">Email (Optional)</label>
                    <input type="email" id="regEmail"
                        class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                        placeholder="john@college.edu">
                </div>

                <div class="mb-6 relative">
                    <label class="block font-semibold mb-2 required">Password</label>
                    <input type="password" id="regPassword" required minlength="6"
                        class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                        placeholder="Minimum 6 characters">
                    <i class="fas fa-eye absolute right-4 top-10 cursor-pointer text-gray-500"
                        onclick="togglePassword('regPassword', this)"></i>
                </div>

                <button type="submit" class="w-full btn-primary mb-4">
                    Create Account
                </button>

                <p class="text-center text-secondary">
                    Already have an account?
                    <button type="button" onclick="closeRegisterModal(); openLoginModal();"
                        class="text-black  font-bold hover:underline">
                        Login
                    </button>
                </p>
            </form>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="productDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Product Details</h2>
                <button onclick="closeProductDetail()" class="text-2xl hover:text-red-500">&times;</button>
            </div>

            <div id="productDetailContent" class="grid md:grid-cols-2 gap-6">
                <!-- Content will be dynamically loaded -->
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üõí Your Cart</h2>
                <button onclick="closeCart()" class="text-2xl hover:text-red-500">&times;</button>
            </div>

            <div id="cartContent">
                <!-- Cart items will be dynamically loaded -->
            </div>

            <div class="mt-6 p-4 bg-gray-100 rounded-xl" style="background-color: var(--bg-secondary);">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-lg font-bold">Total:</span>
                    <span class="text-2xl font-bold text-black " id="cartTotal">‚Çπ0</span>
                </div>
                <button onclick="proceedToCheckout()" class="w-full btn-primary">
                    <i class="fas fa-credit-card mr-2"></i>Proceed to Checkout
                </button>
            </div>
        </div>
    </div>

    <!-- Wishlist Modal -->
    <div id="wishlistModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‚ù§Ô∏è Your Wishlist</h2>
                <button onclick="closeWishlist()" class="text-2xl hover:text-red-500">&times;</button>
            </div>

            <div id="wishlistContent">
                <!-- Wishlist items will be dynamically loaded -->
            </div>
        </div>
    </div>

    <!-- My Orders Modal -->
    <div id="ordersModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üì¶ My Orders</h2>
                <button onclick="closeMyOrders()" class="text-2xl hover:text-red-500">&times;</button>
            </div>

            <div id="ordersContent">
                <!-- Orders will be dynamically loaded -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‚öôÔ∏è Settings</h2>
                <button onclick="closeSettings()" class="text-2xl hover:text-red-500">&times;</button>
            </div>

            <div class="space-y-4">
                <div class="p-4 border-2 rounded-xl border-color">
                    <h3 class="font-bold mb-2">Profile Information</h3>
                    <div class="space-y-2 text-sm text-secondary">
                        <p><strong>Name:</strong> <span id="settingsName"></span></p>
                        <p><strong>Roll Number:</strong> <span id="settingsRoll"></span></p>
                        <p><strong>Branch:</strong> <span id="settingsBranch"></span></p>
                        <p><strong>Year:</strong> <span id="settingsYear"></span></p>
                        <p><strong>Phone:</strong> <span id="settingsPhone"></span></p>
                        <p><strong>Role:</strong> <span id="settingsRole"></span></p>
                    </div>
                </div>


                <div class="p-4 border-2 rounded-xl border-color">
                    <h3 class="font-bold mb-2">Notifications</h3>
                    <label class="flex items-center justify-between cursor-pointer">
                        <span>Email Notifications</span>
                        <input type="checkbox" class="w-5 h-5" checked>
                    </label>
                </div>

                <button onclick="logout()"
                    class="w-full bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600 transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Modal -->
    <div id="dashboardModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üìä Dashboard</h2>
                <button onclick="closeDashboard()" class="text-2xl hover:text-red-500">&times;</button>
            </div>
            <div id="dashboardContent"></div>
        </div>
    </div>

    <!-- My Products Modal -->
    <div id="myProductsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üè∑Ô∏è My Products</h2>
                <button onclick="closeMyProducts()" class="text-2xl hover:text-red-500">&times;</button>
            </div>
            <div id="myProductsContent"></div>
        </div>
    </div>

    <!-- Admin Orders Modal -->
    <div id="adminOrdersModal" class="modal">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-black text-primary">üì¶ Platform Orders</h2>
                <button onclick="closeAdminOrders()" class="text-gray-400 hover:text-red-500 transition"><i
                        class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="adminOrdersContent"></div>
        </div>
    </div>

    <!-- Community Details Modal -->
    <div id="communityModal" class="modal">
        <div class="modal-content max-w-6xl">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">üë•</span>
                    <h2 class="text-3xl font-black text-primary">Community Directory</h2>
                </div>
                <button onclick="closeCommunityDetails()"
                    class="text-gray-400 hover:text-red-500 transition-all text-2xl">&times;</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse bg-white rounded-2xl overflow-hidden shadow-sm">
                    <thead>
                        <tr class="bg-gray-100 border-b-2 border-black">
                            <th class="p-4 font-black uppercase text-xs tracking-wider">User Details</th>
                            <th class="p-4 font-black uppercase text-xs tracking-wider">Contact</th>
                            <th class="p-4 font-black uppercase text-xs tracking-wider">Education</th>
                            <th class="p-4 font-black uppercase text-xs tracking-wider">Role</th>
                            <th class="p-4 font-black uppercase text-xs tracking-wider">Joined</th>
                            <th class="p-4 font-black uppercase text-xs tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="communityTableBody">
                        <!-- Content will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- Live Products Management Modal -->
    <div id="liveProductsModal" class="modal">
        <div class="modal-content max-w-6xl">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">üõçÔ∏è</span>
                    <h2 class="text-3xl font-black text-primary">Live Inventory Management</h2>
                </div>
                <button onclick="closeLiveProducts()"
                    class="text-gray-400 hover:text-red-500 transition-all text-2xl">&times;</button>
            </div>
            <div id="liveProductsContent"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto max-h-[70vh] p-1">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Sell Product Modal -->
    <div id="sellModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üì¶ Sell Your Product</h2>
                <button onclick="closeSellModal()" class="text-2xl hover:text-red-500">&times;</button>
            </div>

            <form id="sellForm" onsubmit="handleSellProduct(event)">
                <div class="mb-4">
                    <label class="block font-semibold mb-2 required">Product Title</label>
                    <input type="text" id="productTitle" required
                        class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                        placeholder="e.g., iPhone 13 Pro - Like New">
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block font-semibold mb-2 required">Category</label>
                        <select id="productCategory" required
                            class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none">
                            <option value="electronics">Electronics</option>
                            <option value="books">Books & Notes</option>
                            <option value="fashion">Fashion</option>
                            <option value="furniture">Furniture</option>
                            <option value="services">Services</option>
                            <option value="sports">Sports</option>
                        </select>
                    </div>

                    <div>
                        <label class="block font-semibold mb-2 required">Condition</label>
                        <select id="productCondition" required
                            class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none">
                            <option value="New">New</option>
                            <option value="Like New">Like New</option>
                            <option value="Good">Good</option>
                            <option value="Fair">Fair</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block font-semibold mb-2 required">Price (‚Çπ)</label>
                        <input type="number" id="productPrice" required min="1"
                            class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                            placeholder="5000">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Original Price (‚Çπ)</label>
                        <input type="number" id="productOriginalPrice" min="1"
                            class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                            placeholder="Optional">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block font-semibold mb-2 required">Quantity</label>
                    <input type="number" id="productQuantity" required min="1" value="1"
                        class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                        placeholder="Available quantity">
                </div>

                <div class="mb-4">
                    <label class="block font-semibold mb-2 required">Description (Max 200 chars)</label>
                    <textarea id="productDescription" required rows="4" maxlength="200"
                        class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                        placeholder="Describe your product in detail..."></textarea>
                </div>

                <div class="mb-4">
                    <label class="block font-semibold mb-2 required">Upload Images</label>
                    <div class="image-upload-area" onclick="document.getElementById('productImages').click()">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 font-medium">Click to upload images</p>
                        <p class="text-sm text-secondary mt-1">Maximum 5 images (JPG, PNG, WebP)</p>
                    </div>
                    <input type="file" id="productImages" accept="image/*" multiple hidden
                        onchange="previewImages(event)">
                    <div id="imagePreview" class="image-preview"></div>
                </div>

                <div class="mb-6">
                    <label class="block font-semibold mb-2">Location on Campus</label>
                    <input type="text" id="productLocation"
                        class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                        placeholder="e.g., North Campus, Hostel Block A">
                </div>

                <button type="submit" class="w-full btn-primary">
                    <i class="fas fa-check mr-2"></i>List Product
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Approval Modal -->
    <div id="adminApprovalsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‚≠ê Pending Product Approvals</h2>
                <button onclick="closeAdminApprovals()" class="text-2xl hover:text-red-500">&times;</button>
            </div>
            <div id="adminApprovalsList" class="max-h-[500px] overflow-y-auto pr-2">
                <!-- Pending products will be listed here -->
            </div>
        </div>
    </div>

    <!-- Admin Login Modal (Secret) -->
    <div id="adminLoginModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üëë Admin Portal</h2>
                <button onclick="closeAdminLogin()" class="text-2xl hover:text-red-500">&times;</button>
            </div>
            <form onsubmit="handleAdminLogin(event)">
                <div class="mb-4 relative">
                    <label class="block font-semibold mb-2">Secret Code</label>
                    <input type="password" id="adminSecretCode" required
                        class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                        placeholder="Enter secret code">
                    <i class="fas fa-eye absolute right-4 top-10 cursor-pointer text-gray-500"
                        onclick="togglePassword('adminSecretCode', this)"></i>
                </div>
                <div class="mb-6 relative">
                    <label class="block font-semibold mb-2">Admin Password</label>
                    <input type="password" id="adminPassword" required
                        class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                        placeholder="Enter admin password">
                    <i class="fas fa-eye absolute right-4 top-10 cursor-pointer text-gray-500"
                        onclick="togglePassword('adminPassword', this)"></i>
                </div>
                <button type="submit" class="w-full btn-primary">Access Admin Panel</button>
            </form>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üîë Reset Password</h2>
                <button onclick="closeForgotPassword()" class="text-2xl hover:text-red-500">&times;</button>
            </div>
            <div id="forgotStep1">
                <div class="mb-4">
                    <label class="block font-semibold mb-2">Roll Number</label>
                    <input type="text" id="forgotRoll"
                        class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                        placeholder="Enter your roll number">
                </div>
                <div class="mb-4">
                    <label class="block font-semibold mb-2">Phone Number</label>
                    <input type="tel" id="forgotPhone" pattern="[0-9]{10}"
                        class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                        placeholder="Registered phone number">
                </div>
                <button onclick="verifyForgotPassword()" class="w-full btn-primary">Verify & Reset</button>
            </div>
            <div id="forgotStep2" style="display: none;">
                <div class="mb-4 relative">
                    <label class="block font-semibold mb-2">New Password</label>
                    <input type="password" id="newPassword"
                        class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                        placeholder="Enter new password">
                    <i class="fas fa-eye absolute right-4 top-10 cursor-pointer text-gray-500"
                        onclick="togglePassword('newPassword', this)"></i>
                    <p class="text-xs text-gray-500 mt-1">8-16 chars, 1 uppercase, 1 lowercase, 1 number</p>
                </div>
                <div class="mb-6 relative">
                    <label class="block font-semibold mb-2">Confirm Password</label>
                    <input type="password" id="confirmNewPassword"
                        class="w-full px-4 py-2 border-2 rounded-xl focus:border-black focus:outline-none"
                        placeholder="Confirm new password">
                    <i class="fas fa-eye absolute right-4 top-10 cursor-pointer text-gray-500"
                        onclick="togglePassword('confirmNewPassword', this)"></i>
                </div>
                <button onclick="resetPassword()" class="w-full btn-primary">Reset Password</button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üí≥ Payment Options</h2>
                <button onclick="closePaymentModal()" class="text-2xl hover:text-red-500">&times;</button>
            </div>
            <div id="paymentDetails" class="mb-4 p-4 bg-gray-100 rounded-xl" style="background: var(--bg-secondary);">
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="selectPayment('COD')" id="codBtn"
                    class="p-4 border-2 rounded-xl text-center hover:border-black transition">
                    <i class="fas fa-money-bill-wave text-3xl text-green-600 mb-2"></i>
                    <div class="font-bold">Cash on Delivery</div>
                    <div class="text-xs text-secondary">Pay when you receive</div>
                </button>
                <button onclick="selectPayment('UPI')" id="upiBtn"
                    class="p-4 border-2 rounded-xl text-center hover:border-black transition">
                    <i class="fas fa-qrcode text-3xl text-black mb-2"></i>
                    <div class="font-bold">UPI Payment</div>
                    <div class="text-xs text-secondary">Pay via QR code</div>
                </button>
            </div>
            <div id="upiQRSection" style="display: none;" class="text-center mb-4">
                <p class="font-bold mb-2">Scan QR Code to Pay</p>
                <div class="inline-block p-4 bg-white rounded-xl">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=upi://pay?pa=admin@campus&pn=CampusMart"
                        alt="UPI QR" class="mx-auto">
                </div>
                <p class="text-sm text-secondary mt-2">UPI ID: admin@campusmart</p>
            </div>
            <button onclick="confirmPayment()" id="confirmPayBtn" class="w-full btn-primary" disabled>Confirm
                Order</button>
        </div>
    </div>

    <!-- Admin Swaps Management Modal -->
    <div id="swapsModal" class="modal">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold font-display">Successful Swaps History</h2>
                <button onclick="closeSwaps()" class="text-gray-400 hover:text-black">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="swapsList" class="grid gap-4 max-h-[70vh] overflow-y-auto custom-scrollbar">
                <!-- Swaps will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Order Success Modal -->
    <div id="orderSuccessModal" class="modal">
        <div class="modal-content text-center max-w-md p-8">
            <div class="mb-6">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-4xl text-green-600"></i>
                </div>
                <h2 class="text-3xl font-bold font-display text-primary mb-2">Order Confirmed!</h2>
                <p class="text-secondary">Thank you for your purchase. Your order has been placed successfully.</p>
            </div>
            <div class="space-y-3">
                <button onclick="closeOrderSuccessModal(); openMyOrders();"
                    class="w-full bg-black text-white py-3 rounded-xl font-bold hover:bg-gray-800 transition">
                    View My Orders
                </button>
                <button onclick="closeOrderSuccessModal(); scrollToProducts();"
                    class="w-full bg-white text-black border-2 border-black py-3 rounded-xl font-bold hover:bg-gray-50 transition">
                    Continue Shopping
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Pending Swaps Modal -->
    <div id="pendingSwapsModal" class="modal">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold font-display">Pending Swaps (Incomplete)</h2>
                <button onclick="closePendingSwaps()" class="text-gray-400 hover:text-black">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="pendingSwapsList" class="grid gap-4 max-h-[70vh] overflow-y-auto custom-scrollbar">
                <!-- Pending Swaps loaded here -->
            </div>
        </div>
    </div>

    <!-- Dynamic Fee Approval Modal -->
    <div id="approveFeeModal" class="modal">
        <div class="modal-content max-w-lg p-8">
            <h2 class="text-2xl font-bold font-display mb-6">Set Platform Fees</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Listing Revenue (From Seller)</label>
                    <div class="flex items-center border-2 border-gray-200 rounded-xl px-3 bg-gray-50">
                        <span class="text-gray-500 mr-2">‚Çπ</span>
                        <input type="number" id="feeListing"
                            class="w-full bg-transparent border-none focus:ring-0 py-3 font-bold" value="0"
                            oninput="updateFeeTotals()">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Service Fee (From Buyer)</label>
                        <div class="flex items-center border-2 border-gray-200 rounded-xl px-3 bg-gray-50">
                            <span class="text-gray-500 mr-2">‚Çπ</span>
                            <input type="number" id="feeService"
                                class="w-full bg-transparent border-none focus:ring-0 py-3 font-bold" value="0"
                                oninput="updateFeeTotals()">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Platform Charge (Extra)</label>
                        <div class="flex items-center border-2 border-gray-200 rounded-xl px-3 bg-gray-50">
                            <span class="text-gray-500 mr-2">‚Çπ</span>
                            <input type="number" id="feePlatform"
                                class="w-full bg-transparent border-none focus:ring-0 py-3 font-bold" value="0"
                                oninput="updateFeeTotals()">
                        </div>
                    </div>
                </div>

                <div class="bg-black text-white p-4 rounded-xl mt-4">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-gray-300">Consolidated Earnings</span>
                        <span class="font-bold text-2xl text-yellow-400" id="feeTotal">‚Çπ0</span>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="closeFeeModal()"
                        class="flex-1 py-3 font-bold text-gray-500 hover:text-black">Cancel</button>
                    <button onclick="confirmApprovalWithFees()"
                        class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 shadow-lg shadow-green-200">
                        Confirm & Approve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- How It Works Modal -->
    <div id="howItWorksModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üîÑ How It Works</h2>
                <button onclick="closeHowItWorksModal()" class="text-2xl hover:text-red-500">&times;</button>
            </div>

            <div class="space-y-6">
                <div class="p-4 bg-blue-50 rounded-xl border-2 border-blue-200">
                    <h3 class="font-bold text-lg mb-2 text-blue-800">üë§ For Buyers</h3>
                    <ol class="list-decimal list-inside space-y-2 text-gray-700">
                        <li>Register as a <strong>Buyer</strong> with your college details</li>
                        <li>Browse products listed by verified sellers</li>
                        <li>Add items to cart and proceed to checkout</li>
                        <li>Choose payment method (COD or UPI)</li>
                        <li>Wait for seller to accept and deliver to admin</li>
                        <li>Collect your product from admin and confirm delivery</li>
                    </ol>
                </div>

                <div class="p-4 bg-green-50 rounded-xl border-2 border-green-200">
                    <h3 class="font-bold text-lg mb-2 text-green-800">üè∑Ô∏è For Sellers</h3>
                    <ol class="list-decimal list-inside space-y-2 text-gray-700">
                        <li>Register as a <strong>Seller</strong> with your college ID</li>
                        <li>List your products with photos and description</li>
                        <li>Wait for admin approval (ensures quality listings)</li>
                        <li>Receive order notifications when someone buys</li>
                        <li>Accept order and deliver product to admin</li>
                        <li>Receive payment (minus platform fee) after buyer confirms</li>
                    </ol>
                </div>

                <div class="p-4 bg-purple-50 rounded-xl border-2 border-purple-200">
                    <h3 class="font-bold text-lg mb-2 text-purple-800">üëë Admin Role</h3>
                    <ul class="list-disc list-inside space-y-2 text-gray-700">
                        <li>Approves seller product listings</li>
                        <li>Acts as trusted middleman for transactions</li>
                        <li>Receives products from sellers</li>
                        <li>Notifies buyers for pickup</li>
                        <li>Ensures safe and verified transactions</li>
                        <li>Manages platform fees and disputes</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Safety Tips Modal -->
    <div id="safetyTipsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üõ°Ô∏è Safety Tips</h2>
                <button onclick="closeSafetyTipsModal()" class="text-2xl hover:text-red-500">&times;</button>
            </div>

            <div class="space-y-4">
                <div class="p-4 bg-yellow-50 rounded-xl border-l-4 border-yellow-500">
                    <h4 class="font-bold text-yellow-800 mb-1">‚úÖ Meet On Campus Only</h4>
                    <p class="text-gray-600 text-sm">Always conduct transactions within college premises for safety.</p>
                </div>

                <div class="p-4 bg-yellow-50 rounded-xl border-l-4 border-yellow-500">
                    <h4 class="font-bold text-yellow-800 mb-1">üîç Inspect Before Accepting</h4>
                    <p class="text-gray-600 text-sm">Check the product condition thoroughly before confirming delivery.
                    </p>
                </div>

                <div class="p-4 bg-yellow-50 rounded-xl border-l-4 border-yellow-500">
                    <h4 class="font-bold text-yellow-800 mb-1">üí≥ Use Platform Payments</h4>
                    <p class="text-gray-600 text-sm">Prefer platform payment methods. Avoid direct cash transfers to
                        strangers.</p>
                </div>

                <div class="p-4 bg-yellow-50 rounded-xl border-l-4 border-yellow-500">
                    <h4 class="font-bold text-yellow-800 mb-1">üìû Verify Seller/Buyer</h4>
                    <p class="text-gray-600 text-sm">All users are verified students. Contact admin if you have
                        concerns.</p>
                </div>

                <div class="p-4 bg-yellow-50 rounded-xl border-l-4 border-yellow-500">
                    <h4 class="font-bold text-yellow-800 mb-1">‚ö†Ô∏è Report Suspicious Activity</h4>
                    <p class="text-gray-600 text-sm">Report any suspicious behavior or fake listings to admin
                        immediately.</p>
                </div>

                <div class="p-4 bg-red-50 rounded-xl border-l-4 border-red-500">
                    <h4 class="font-bold text-red-800 mb-1">üö´ Never Share Personal Info</h4>
                    <p class="text-gray-600 text-sm">Don't share bank details, OTPs, or personal documents with
                        buyers/sellers.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        function factoryReset() {
            if (confirm('‚ö†Ô∏è DANGER: This will delete ALL users, orders, and products! Proceed?')) {
                if (confirm('Are you absolutely sure? This cannot be undone.')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }
        // Sample Products Data
        let products = [
            {
                id: 1,
                title: "MacBook Pro M1 - Excellent Condition",
                price: 85000,
                originalPrice: 120000,
                image: "https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=400",
                seller: "Rahul Sharma",
                sellerPhone: "9876543210",
                sellerRoll: "21CS001",
                sellerAvatar: "https://ui-avatars.com/api/?name=Rahul+Sharma&background=667eea&color=fff",
                rating: 4.8,
                location: "North Campus",
                condition: "Like New",
                verified: true,
                eco: false,
                category: "electronics",
                description: "MacBook Pro M1 chip with 8GB RAM and 256GB SSD. Barely used for 6 months. All accessories included. Perfect for coding and design work."
            },
            {
                id: 2,
                title: "Engineering Mathematics Textbook Set",
                price: 800,
                originalPrice: 2500,
                image: "https://images.unsplash.com/photo-1544947950-fa07a98d237f?w=400",
                seller: "Priya Verma",
                sellerPhone: "9876543211",
                sellerRoll: "21CS002",
                sellerAvatar: "https://ui-avatars.com/api/?name=Priya+Verma&background=f59e0b&color=fff",
                rating: 5.0,
                location: "South Campus",
                condition: "Good",
                verified: true,
                eco: true,
                category: "books",
                description: "Complete set of Engineering Mathematics books for first year. All volumes included with solved examples and previous year papers."
            },
            {
                id: 3,
                title: "Gaming Chair - Almost New",
                price: 8500,
                originalPrice: 15000,
                image: "https://images.unsplash.com/photo-1598550476439-6847785fcea6?w=400",
                seller: "Amit Patel",
                sellerPhone: "9876543212",
                sellerRoll: "21CS003",
                sellerAvatar: "https://ui-avatars.com/api/?name=Amit+Patel&background=ec4899&color=fff",
                rating: 4.6,
                location: "East Campus",
                condition: "Like New",
                verified: true,
                eco: false,
                category: "furniture",
                description: "Ergonomic gaming chair with lumbar support. Used for only 3 months. Very comfortable for long study sessions."
            },
            {
                id: 4,
                title: "Branded Backpack - College Edition",
                price: 1200,
                originalPrice: 2500,
                image: "https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=400",
                seller: "Sneha Das",
                sellerPhone: "9876543213",
                sellerRoll: "21CS004",
                sellerAvatar: "https://ui-avatars.com/api/?name=Sneha+Das&background=10b981&color=fff",
                rating: 4.9,
                location: "West Campus",
                condition: "Good",
                verified: false,
                eco: true,
                category: "fashion",
                description: "Spacious backpack perfect for college. Multiple compartments for laptop, books, and essentials."
            }
        ];

        // Load products from storage or seed with samples
        // Load products from storage or seed with samples
        const storedProducts = localStorage.getItem('campusMartProducts');

        try {
            if (storedProducts) {
                const parsed = JSON.parse(storedProducts);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    products = parsed;
                } else {
                    console.warn('Storage corrupt or empty, re-seeding');
                    localStorage.setItem('campusMartProducts', JSON.stringify(products));
                }
            } else {
                // First time load: Seed with sample data
                localStorage.setItem('campusMartProducts', JSON.stringify(products));
            }
        } catch (e) {
            console.error('CRITICAL ERROR LOADING PRODUCTS:', e);
            // Fallback to sample data and overwrite storage
            localStorage.setItem('campusMartProducts', JSON.stringify(products));
        }

        // --- ONE-TIME DATA WIPE TO FIX CORRUPTION ---
        if (!sessionStorage.getItem('dataWipedFix')) {
            console.warn('PERFORMING ONE-TIME HARD WIPE');
            localStorage.removeItem('campusMartProducts');
            sessionStorage.setItem('dataWipedFix', 'true');
            location.reload();
        }
        // ---------------------------------------------

        // Global Variables
        let currentUser = null;
        let cart = [];
        let wishlist = [];
        let notifications = [];
        let orders = [];
        let allPlatformOrders = [];
        let earnings = { listingFees: 0, serviceFees: 0, total: 0 };
        let lastUploadedImages = [];
        let currentCategory = 'all';
        const ADMIN_SECRET = 'ADMIN2025';
        const LISTING_FEE = 15;

        // Calculate Service Fee (Tiered)
        function calculateServiceFee(price) {
            if (price <= 500) return Math.max(20, Math.round(price * 0.05));
            if (price <= 2000) return Math.round(price * 0.05);
            if (price <= 10000) return Math.round(price * 0.04);
            if (price <= 30000) return Math.round(price * 0.03);
            return Math.min(1000, Math.round(price * 0.02));
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            checkAuth();
            renderProducts();
            loadNotifications();
        });

        // Dark Mode Logic Removed

        // Authentication
        function checkAuth() {
            const user = localStorage.getItem('campusMartUser');
            if (user) {
                currentUser = JSON.parse(user);
                updateUIForLoggedInUser();
                loadUserData();
            } else {
                updateUIForLoggedOutUser();
            }
        }

        function updateUIForLoggedInUser() {
            document.getElementById('loggedOutNav').classList.add('hidden');
            document.getElementById('loggedInNav').classList.remove('hidden');
            document.getElementById('loggedInNav').classList.add('flex');

            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=000000&color=fff`;

            // Update menu info
            document.getElementById('menuUserName').textContent = currentUser.name;
            document.getElementById('menuUserEmail').textContent = currentUser.email || currentUser.phone;

            // Role-based UI Visibility
            document.body.classList.remove('role-buyer', 'role-seller', 'role-admin');
            document.body.classList.add(`role-${currentUser.role}`);

            // Toggle Search Bar for Admin
            const searchBar = document.getElementById('topSearchBar');
            if (currentUser.role === 'admin') {
                searchBar.classList.remove('md:flex');
                searchBar.classList.add('hidden');
            } else {
                searchBar.classList.remove('hidden');
                searchBar.classList.add('md:flex');
            }

            const sellElements = ['navSellBtn', 'heroSellBtn', 'menuMyProducts'];
            if (currentUser.role === 'buyer' || currentUser.role === 'admin') {
                sellElements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.setProperty('display', 'none', 'important');
                });
            } else {
                sellElements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = '';
                });
            }

            const adminHiddenElements = ['navWishlist', 'navNotifications', 'navCart', 'menuMyOrders', 'menuWishlist'];
            if (currentUser.role === 'admin') {
                adminHiddenElements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.setProperty('display', 'none', 'important');
                });
            } else {
                adminHiddenElements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = '';
                });
            }

            // Admin Main Page Dashboard
            const adminMain = document.getElementById('adminDashboardLanding');
            if (currentUser.role === 'admin') {
                adminMain.classList.remove('hidden');
                renderAdminLanding();
            } else {
                adminMain.classList.add('hidden');
            }
        }

        function renderAdminLanding() {
            const adminMain = document.getElementById('adminDashboardLanding');
            const users = JSON.parse(localStorage.getItem('campusMartUsers') || '[]');
            const pendingProducts = products.filter(p => p.status === 'pending').length;

            adminMain.innerHTML = `
                <div class="flex items-center gap-3 mb-8">
                    <span class="text-4xl">üëë</span>
                    <h1 class="text-4xl font-bold text-primary">Admin Control Center</h1>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div onclick="openCommunityDetails()" class="bg-white p-6 rounded-3xl border-2 border-black shadow-sm cursor-pointer hover:scale-[1.02] transition-transform active:scale-95 group">
                        <div class="text-secondary text-sm font-bold uppercase mb-2 group-hover:text-primary transition-colors">Total Community</div>
                        <div class="flex justify-between items-end">
                            <div class="text-4xl font-black text-black">${users.length}</div>
                            <div class="text-primary opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </div>
                    <div onclick="openLiveProducts()" class="bg-white p-6 rounded-3xl border-2 border-black shadow-sm cursor-pointer hover:scale-[1.02] transition-transform active:scale-95 group">
                        <div class="text-secondary text-sm font-bold uppercase mb-2 group-hover:text-blue-600 transition-colors">Live Products</div>
                        <div class="flex justify-between items-end">
                            <div class="text-4xl font-black text-blue-600">${products.filter(p => p.status === 'approved').length}</div>
                            <div class="text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </div>
                    <div onclick="openSwaps()" class="bg-white p-6 rounded-3xl border-2 border-black shadow-sm cursor-pointer hover:scale-[1.02] transition-transform active:scale-95 group">
                        <div class="text-secondary text-sm font-bold uppercase mb-2 group-hover:text-green-600 transition-colors">Successful Swaps</div>
                        <div class="flex justify-between items-end">
                            <div class="text-4xl font-black text-green-600">${allPlatformOrders.length}</div>
                            <div class="text-green-600 opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl border-2 border-black shadow-sm">
                        <div class="text-secondary text-sm font-bold uppercase mb-2">Awaiting Review</div>
                        <div class="text-4xl font-black ${pendingProducts > 0 ? 'text-red-500 animate-pulse' : 'text-gray-400'}">${pendingProducts}</div>
                    </div>
                    <div onclick="openPendingSwaps()" class="bg-white p-6 rounded-3xl border-2 border-black shadow-sm cursor-pointer hover:scale-[1.02] transition-transform active:scale-95 group">
                        <div class="text-secondary text-sm font-bold uppercase mb-2 group-hover:text-orange-500 transition-colors">Pending Swaps</div>
                        <div class="flex justify-between items-end">
                            <div class="text-4xl font-black text-orange-500">${allPlatformOrders.filter(o => o.status !== 'completed' && o.status !== 'cancelled').length}</div>
                            <div class="text-orange-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-12 gap-8">
                    <div class="md:col-span-8">
                        <div class="bg-white p-6 rounded-3xl border-2 border-black mb-8 shadow-sm">
                            <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
                                <i class="fas fa-chart-line text-green-600"></i>
                                Platform Revenue
                            </h3>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="p-4 bg-gray-50 rounded-2xl border">
                                    <div class="text-secondary text-xs uppercase font-bold">Listing Revenue</div>
                                    <div class="text-2xl font-bold">‚Çπ${earnings.listingFees}</div>
                                </div>
                                <div class="p-4 bg-gray-50 rounded-2xl border">
                                    <div class="text-secondary text-xs uppercase font-bold">Service Fees</div>
                                    <div class="text-2xl font-bold">‚Çπ${earnings.serviceFees}</div>
                                </div>
                            </div>
                            <div class="p-4 bg-black text-white rounded-2xl flex justify-between items-center">
                                <span class="text-lg font-bold">Consolidated Earnings</span>
                                <span class="text-3xl font-black text-yellow-300">‚Çπ${earnings.total}</span>
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button onclick="openAdminOrders()" class="flex-1 bg-black text-white py-4 rounded-2xl font-black text-lg hover:scale-[1.02] transition shadow-lg">
                                <i class="fas fa-shopping-cart mr-2"></i> MANAGE ALL ORDERS
                            </button>
                            ${pendingProducts > 0 ? `
                            <button onclick="openAdminApprovals()" class="flex-1 bg-orange-500 text-white py-4 rounded-2xl font-black text-lg hover:scale-[1.02] transition shadow-lg animate-bounce">
                                <i class="fas fa-star mr-2"></i> REVIEW ${pendingProducts} NEW REQUESTS
                            </button>
                            ` : ''}
                        </div>
                    </div>

                    <div class="md:col-span-4">
                        <div class="bg-white p-6 rounded-3xl border-2 border-black shadow-sm sticky top-24">
                            <h4 class="font-bold mb-4 flex items-center gap-2">
                                <i class="fas fa-shield-alt text-blue-600"></i>
                                Admin Quick Actions
                            </h4>
                            <div class="space-y-3">
                                <button onclick="window.scrollTo(0,0); location.reload();" class="w-full text-left p-3 rounded-xl hover:bg-gray-100 flex items-center gap-3 transition border">
                                    <i class="fas fa-sync"></i>
                                    <span>Refresh Platform Data</span>
                                </button>
                                <button onclick="openSettings()" class="w-full text-left p-3 rounded-xl hover:bg-gray-100 flex items-center gap-3 transition border">
                                    <i class="fas fa-user-lock"></i>
                                    <span>Control Settings</span>
                                </button>
                                <button onclick="logout()" class="w-full text-left p-3 rounded-xl hover:bg-red-50 text-red-600 flex items-center gap-3 transition border border-red-100">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Secure Logout</span>
                                </button>
                                <button onclick="factoryReset()" class="w-full text-left p-3 rounded-xl hover:bg-red-600 hover:text-white text-red-600 flex items-center gap-3 transition border border-red-200 mt-4 font-bold bg-red-50">
                                    <i class="fas fa-bomb"></i>
                                    <span>Factory Reset Data</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateUIForLoggedOutUser() {
            document.getElementById('loggedOutNav').classList.remove('hidden');
            document.getElementById('loggedInNav').classList.add('hidden');
            document.body.classList.remove('role-buyer', 'role-seller', 'role-admin');
            document.getElementById('adminDashboardLanding').classList.add('hidden');

            // Reset Search Bar
            const searchBar = document.getElementById('topSearchBar');
            if (searchBar) {
                searchBar.classList.remove('hidden');
                searchBar.classList.add('md:flex');
            }
        }


        // Load User Data
        function loadUserData() {
            cart = JSON.parse(localStorage.getItem(`cart_${currentUser.rollNumber}`) || '[]');
            wishlist = JSON.parse(localStorage.getItem(`wishlist_${currentUser.rollNumber}`) || '[]');
            orders = JSON.parse(localStorage.getItem(`orders_${currentUser.rollNumber}`) || '[]');
            notifications = JSON.parse(localStorage.getItem(`notifications_${currentUser.rollNumber}`) || '[]');
            allPlatformOrders = JSON.parse(localStorage.getItem('allPlatformOrders') || '[]');
            earnings = JSON.parse(localStorage.getItem('platformEarnings') || '{"listingFees":0,"serviceFees":0,"total":0}');

            updateCartBadge();
            updateWishlistBadge();
            updateNotificationBadge();
        }

        // Login Role Selection
        function selectLoginRole(role, event) {
            document.querySelectorAll('#loginModal .role-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            document.getElementById('loginRole').value = role;

            // Show/hide admin secret field
            if (role === 'admin') {
                document.getElementById('adminSecretField').style.display = 'block';
                document.getElementById('regularLoginFields').style.display = 'none';
            } else {
                document.getElementById('adminSecretField').style.display = 'none';
                document.getElementById('regularLoginFields').style.display = 'block';
            }
        }

        // Handle Login
        function handleLogin(event) {
            event.preventDefault();

            const role = document.getElementById('loginRole').value;
            if (!role) {
                showToast('Please select a role', 'error');
                return;
            }

            // Admin Login
            if (role === 'admin') {
                const secretCode = document.getElementById('loginAdminSecret').value;
                if (secretCode !== ADMIN_SECRET) {
                    showToast('Invalid admin secret code', 'error');
                    return;
                }

                // Check for admin in database
                const users = JSON.parse(localStorage.getItem('campusMartUsers') || '[]');
                const admin = users.find(u => u.role === 'admin' && u.secretCode === secretCode);

                if (admin) {
                    currentUser = admin;
                    localStorage.setItem('campusMartUser', JSON.stringify(admin));
                    closeLoginModal();
                    showToast('Admin login successful! üëë', 'success');
                    updateUIForLoggedInUser();
                    loadUserData();
                } else {
                    showToast('Admin account not found', 'error');
                }
                return;
            }

            // Regular Login (Buyer/Seller)
            const rollNumber = document.getElementById('loginRollNumber').value;
            const phone = document.getElementById('loginPhone').value;
            const password = document.getElementById('loginPassword').value;

            const users = JSON.parse(localStorage.getItem('campusMartUsers') || '[]');
            const user = users.find(u =>
                u.rollNumber === rollNumber &&
                u.phone === phone &&
                u.password === password &&
                u.role !== 'admin'
            );

            if (user) {
                currentUser = user;
                localStorage.setItem('campusMartUser', JSON.stringify(user));
                closeLoginModal();
                showToast('Login successful! Welcome back ' + user.name + ' üéâ', 'success');
                updateUIForLoggedInUser();
                loadUserData();
            } else {
                showToast('Invalid credentials. Please check roll number, phone and password', 'error');
            }
        }

        // Register Role Selection
        function selectRole(role, event) {
            document.querySelectorAll('#registerModal .role-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            document.getElementById('selectedRole').value = role;

            // Show/hide admin secret field
            if (role === 'admin') {
                document.getElementById('adminSecretRegField').style.display = 'block';
            } else {
                document.getElementById('adminSecretRegField').style.display = 'none';
            }
        }

        // Handle Register
        function handleRegister(event) {
            event.preventDefault();

            const role = document.getElementById('selectedRole').value;
            if (!role) {
                showToast('Please select a role', 'error');
                return;
            }

            // Admin Registration Check
            if (role === 'admin') {
                const secretCode = document.getElementById('regAdminSecret').value;
                if (secretCode !== ADMIN_SECRET) {
                    showToast('Invalid admin secret code. Only authorized admins can register.', 'error');
                    return;
                }
            }

            const userData = {
                name: document.getElementById('regName').value,
                rollNumber: document.getElementById('regRollNumber').value,
                branch: document.getElementById('regBranch').value,
                year: document.getElementById('regYear').value,
                phone: document.getElementById('regPhone').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                role: role,
                secretCode: role === 'admin' ? ADMIN_SECRET : null,
                registeredAt: new Date().toISOString()
            };

            // Enhanced Validation
            if (!userData.name || !userData.rollNumber || !userData.branch || !userData.year || !userData.phone || !userData.password) { showToast('All fields are required', 'error'); return; }
            if (!validateName(userData.name)) { showToast('Name must have at least 3 alphabetic characters (spaces not counted)', 'error'); return; }
            if (!validateRollNumber(userData.rollNumber)) { showToast('Roll number must contain at least 1 letter and 1 number, no spaces allowed', 'error'); return; }
            if (!validatePhone(userData.phone)) { showToast('Phone: 10 digits only', 'error'); return; }

            const users = JSON.parse(localStorage.getItem('campusMartUsers') || '[]');
            if (users.find(u => u.rollNumber === userData.rollNumber)) {
                showToast('Roll number already registered', 'error');
                return;
            }

            users.push(userData);
            localStorage.setItem('campusMartUsers', JSON.stringify(users));

            currentUser = userData;
            localStorage.setItem('campusMartUser', JSON.stringify(userData));

            closeRegisterModal();
            showToast('Account created successfully! Welcome ' + userData.name + ' üéâ', 'success');
            updateUIForLoggedInUser();
            loadUserData();
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('campusMartUser');
                currentUser = null;
                cart = [];
                wishlist = [];
                notifications = [];
                updateUIForLoggedOutUser();
                closeSettings();
                showToast('Logged out successfully', 'info');
            }
        }

        // Product Detail
        function showProductDetail(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const content = `
                <div>
                    <img src="${product.image}" alt="${product.title}" class="w-full h-64 object-cover rounded-xl mb-4">
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <img src="${product.image}" class="w-full h-20 object-cover rounded cursor-pointer opacity-50 hover:opacity-100">
                        <img src="${product.image}" class="w-full h-20 object-cover rounded cursor-pointer opacity-50 hover:opacity-100">
                        <img src="${product.image}" class="w-full h-20 object-cover rounded cursor-pointer opacity-50 hover:opacity-100">
                    </div>
                </div>
                <div>
                    <h3 class="text-2xl font-bold mb-3 text-primary">${product.title}</h3>

                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-3xl font-bold text-black ">‚Çπ${product.price.toLocaleString()}</span>
                        ${product.originalPrice ? `
                            <span class="text-lg text-gray-500 line-through">‚Çπ${product.originalPrice.toLocaleString()}</span>
                            <span class="badge bg-green-500 text-white">${Math.round((1 - product.price / product.originalPrice) * 100)}% OFF</span>
                        ` : ''}
                    </div>

                    <div class="space-y-3 mb-4">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-tag text-black "></i>
                            <span class="text-secondary">Category:</span>
                            <span class="font-semibold text-primary">${product.category}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-600"></i>
                            <span class="text-secondary">Condition:</span>
                            <span class="font-semibold text-primary">${product.condition}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-map-marker-alt text-red-600"></i>
                            <span class="text-secondary">Location:</span>
                            <span class="font-semibold text-primary">${product.location}</span>
                        </div>
                    </div>

                    <div class="border-t border-b py-4 mb-4 border-color">
                        <h4 class="font-bold mb-2 text-primary">Seller Information</h4>
                        ${(currentUser && (currentUser.role === 'admin' || currentUser.rollNumber === product.sellerRoll)) ? `
                            <div class="flex items-center gap-3 mb-2">
                                <img src="${product.sellerAvatar}" class="w-12 h-12 rounded-full">
                                <div>
                                    <div class="font-bold text-primary">${product.seller} <i class="fas fa-check-circle text-blue-500"></i></div>
                                    <div class="text-sm text-secondary">Roll: ${product.sellerRoll}</div>
                                    <div class="text-sm text-secondary">Phone: ${product.sellerPhone}</div>
                                </div>
                            </div>
                        ` : `
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-12 h-12 rounded-full bg-black flex items-center justify-center text-white text-xl">
                                    <i class="fas fa-user-shield"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-primary">Verified Seller <i class="fas fa-check-circle text-blue-500"></i></div>
                                    <div class="text-sm text-green-600">‚úì Verified by Admin</div>
                                    <div class="text-xs text-secondary">Contact admin for seller details</div>
                                </div>
                            </div>
                        `}
                        <div class="flex items-center gap-1">
                            <i class="fas fa-star text-yellow-500"></i>
                            <span class="font-bold">${product.rating}</span>
                            <span class="text-sm text-secondary">(24 reviews)</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4 class="font-bold mb-2 text-primary">Description</h4>
                        <p class="text-secondary">${product.description}</p>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="addToCart(${product.id})" class="btn-primary">
                            <i class="fas fa-shopping-cart mr-2"></i>Add to Cart
                        </button>
                        <button onclick="buyNow(${product.id})" class="bg-orange-500 text-white px-6 py-3 rounded-xl font-semibold hover:bg-orange-600 transition">
                            <i class="fas fa-bolt mr-2"></i>Buy Now
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('productDetailContent').innerHTML = content;
            document.getElementById('productDetailModal').style.display = 'block';
        }

        function closeProductDetail() {
            document.getElementById('productDetailModal').style.display = 'none';
        }

        // Cart Functions
        function addToCart(productId, event) {
            if (event) event.stopPropagation();

            if (!currentUser) {
                showToast('Please login to add items to cart', 'error');
                openLoginModal();
                return;
            }

            const product = products.find(p => p.id === productId);
            if (!cart.find(item => item.id === productId)) {
                cart.push(product);
                localStorage.setItem(`cart_${currentUser.rollNumber}`, JSON.stringify(cart));
                updateCartBadge();
                showToast(`${product.title.substring(0, 30)}... added to cart! üõí`, 'success');
            } else {
                showToast('Product already in cart', 'info');
            }
        }

        function buyNow(productId) {
            if (!currentUser) {
                showToast('Please login to buy products', 'error');
                openLoginModal();
                return;
            }

            addToCart(productId);
            closeProductDetail();
            openCart();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            localStorage.setItem(`cart_${currentUser.rollNumber}`, JSON.stringify(cart));
            updateCartBadge();
            openCart(); // Refresh cart view
            showToast('Item removed from cart', 'info');
        }

        function updateCartBadge() {
            document.getElementById('cartCount').textContent = cart.length;
        }

        function openCart() {
            if (!currentUser) {
                showToast('Please login to view cart', 'error');
                openLoginModal();
                return;
            }

            if (cart.length === 0) {
                document.getElementById('cartContent').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-shopping-cart text-6xl text-gray-300 mb-4"></i>
                        <p class="text-xl text-secondary">Your cart is empty</p>
                        <button onclick="closeCart(); scrollToProducts();" class="mt-4 btn-primary">
                            Browse Products
                        </button>
                    </div>
                `;
            } else {
                const cartHTML = cart.map(item => `
                    <div class="flex gap-4 p-4 border-b border-color">
                        <img src="${item.image}" alt="${item.title}" class="w-20 h-20 object-cover rounded">
                        <div class="flex-1">
                            <h4 class="font-bold text-primary">${item.title}</h4>
                            <p class="text-sm text-secondary">${item.condition}</p>
                            <p class="text-lg font-bold text-black ">‚Çπ${item.price.toLocaleString()}</p>
                        </div>
                        <button onclick="removeFromCart(${item.id})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');

                document.getElementById('cartContent').innerHTML = cartHTML;

                const total = cart.reduce((sum, item) => sum + item.price, 0);
                document.getElementById('cartTotal').textContent = `‚Çπ${total.toLocaleString()}`;
            }

            document.getElementById('cartModal').style.display = 'block';
        }

        function closeCart() {
            document.getElementById('cartModal').style.display = 'none';
        }

        function proceedToCheckout() {
            if (cart.length === 0) return;
            if (currentUser.role === 'seller') {
                showToast('Sellers cannot buy. Use your buyer account.', 'error');
                return;
            }
            const total = cart.reduce((sum, i) => sum + i.price, 0);
            showPaymentModal([...cart], total);
        }

        function finalizeCheckout(payment, paymentMethod) {
            console.log('Finalizing Checkout...', payment, paymentMethod);
            try {
                const users = JSON.parse(localStorage.getItem('campusMartUsers') || '[]');
                const admins = users.filter(u => u.role === 'admin');


                payment.items.forEach(item => {
                    // check for admin overrides
                    const serviceFee = (item.adminServiceFee !== undefined) ? item.adminServiceFee : calculateServiceFee(item.price);
                    const platformCharge = (item.adminPlatformCharge !== undefined) ? item.adminPlatformCharge : 0;

                    const totalPaid = item.price + serviceFee + platformCharge;

                    // Listing fee deduction
                    const listingFee = (item.adminListingFee !== undefined) ? item.adminListingFee : LISTING_FEE;
                    const sellerPayout = item.price - listingFee;

                    const order = {
                        id: Date.now() + Math.random(),
                        product: item,
                        buyer: { name: currentUser.name, roll: currentUser.rollNumber, phone: currentUser.phone },
                        seller: { name: item.seller, phone: item.sellerPhone, roll: item.sellerRoll },
                        productPrice: item.price,
                        serviceFee: serviceFee,
                        totalPaid: totalPaid,
                        listingFee: LISTING_FEE,
                        sellerPayout: sellerPayout,
                        paymentMethod: paymentMethod,
                        status: 'pending',
                        sellerAccepted: false,
                        orderedAt: new Date().toISOString()
                    };

                    orders.push(order);
                    allPlatformOrders.push(order);
                    earnings.serviceFees += serviceFee;
                    earnings.listingFees += listingFee;
                    earnings.total = earnings.serviceFees + earnings.listingFees;

                    // Notify seller to accept
                    const sellerNotifs = JSON.parse(localStorage.getItem(`notifications_${item.sellerRoll}`) || '[]');
                    sellerNotifs.unshift({ id: Date.now(), title: 'üõí New Order - Accept?', message: `Someone wants "${item.title}". Accept to proceed.`, orderId: order.id, type: 'seller-accept', time: new Date().toISOString(), read: false });
                    localStorage.setItem(`notifications_${item.sellerRoll}`, JSON.stringify(sellerNotifs));

                    // Notify admins
                    admins.forEach(admin => {
                        const an = JSON.parse(localStorage.getItem(`notifications_${admin.rollNumber}`) || '[]');
                        an.unshift({ id: Date.now(), title: 'üì¶ New Order', message: `"${item.title}" - Wait for seller accept`, time: new Date().toISOString(), read: false });
                        localStorage.setItem(`notifications_${admin.rollNumber}`, JSON.stringify(an));
                    });
                    // Update inventory
                    const prodIdx = products.findIndex(p => p.id === item.id);
                    if (prodIdx > -1) {
                        if (products[prodIdx].quantity > 1) {
                            products[prodIdx].quantity -= 1;
                        } else {
                            // Remove if quantity is 1 (or 0)
                            products.splice(prodIdx, 1);
                        }
                    }
                    const savedProds = JSON.parse(localStorage.getItem('campusMartProducts') || '[]');
                    const savedIdx = savedProds.findIndex(p => p.id === item.id);
                    if (savedIdx > -1) {
                        if (savedProds[savedIdx].quantity > 1) {
                            savedProds[savedIdx].quantity -= 1;
                        } else {
                            savedProds.splice(savedIdx, 1);
                        }
                        localStorage.setItem('campusMartProducts', JSON.stringify(savedProds));
                    }
                });

                // Reload products after inventory update
                renderProducts(currentCategory);

                localStorage.setItem(`orders_${currentUser.rollNumber}`, JSON.stringify(orders));
                localStorage.setItem('allPlatformOrders', JSON.stringify(allPlatformOrders));
                localStorage.setItem('platformEarnings', JSON.stringify(earnings));

                // Reload products after inventory update
                renderProducts(currentCategory);

                localStorage.setItem(`orders_${currentUser.rollNumber}`, JSON.stringify(orders));
                localStorage.setItem('allPlatformOrders', JSON.stringify(allPlatformOrders));
                localStorage.setItem('platformEarnings', JSON.stringify(earnings));

                cart = [];
                localStorage.setItem(`cart_${currentUser.rollNumber}`, JSON.stringify(cart));
                updateCartBadge();

                addNotification('Order Placed', `Paid via ${paymentMethod}. Waiting for seller to accept.`);
                // Show Success Modal instead of Toast/Redirect
                console.log('Opening Success Modal via finalizeCheckout');
                openOrderSuccessModal();
            } catch (error) {
                console.error('Finalize Checkout Failed:', error);
                alert('Checkout Error: ' + error.message);
            }
        }

        function openOrderSuccessModal() {
            document.getElementById('orderSuccessModal').style.display = 'block';
        }

        function closeOrderSuccessModal() {
            document.getElementById('orderSuccessModal').style.display = 'none';
        }

        // Wishlist Functions
        function toggleLike(productId, event) {
            if (event) event.stopPropagation();

            if (!currentUser) {
                showToast('Please login to save products', 'error');
                openLoginModal();
                return;
            }

            const product = products.find(p => p.id === productId);
            const index = wishlist.findIndex(item => item.id === productId);

            if (index > -1) {
                wishlist.splice(index, 1);
                showToast('Removed from wishlist', 'info');
            } else {
                wishlist.push(product);
                showToast('Added to wishlist! ‚ù§Ô∏è', 'success');
                // Go to wishlist as requested
                openWishlist();
            }

            localStorage.setItem(`wishlist_${currentUser.rollNumber}`, JSON.stringify(wishlist));
            updateWishlistBadge();

            // Update heart icon
            if (event) {
                const icon = event.target.closest('button').querySelector('i');
                if (icon) {
                    icon.classList.toggle('far');
                    icon.classList.toggle('fas');
                    icon.classList.toggle('text-red-500');
                }
            }
        }

        function updateWishlistBadge() {
            document.getElementById('wishlistCount').textContent = wishlist.length;
        }

        function openWishlist() {
            if (!currentUser) {
                showToast('Please login to view wishlist', 'error');
                openLoginModal();
                return;
            }

            if (wishlist.length === 0) {
                document.getElementById('wishlistContent').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-heart text-6xl text-gray-300 mb-4"></i>
                        <p class="text-xl text-secondary">Your wishlist is empty</p>
                        <button onclick="closeWishlist(); scrollToProducts();" class="mt-4 btn-primary">
                            Browse Products
                        </button>
                    </div>
                `;
            } else {
                const wishlistHTML = wishlist.map(item => `
                    <div class="flex gap-4 p-4 border-b border-color">
                        <img src="${item.image}" alt="${item.title}" class="w-20 h-20 object-cover rounded cursor-pointer" onclick="closeWishlist(); showProductDetail(${item.id});">
                        <div class="flex-1">
                            <h4 class="font-bold text-primary cursor-pointer" onclick="closeWishlist(); showProductDetail(${item.id});">${item.title}</h4>
                            <p class="text-sm text-secondary">${item.condition} | ${item.location}</p>
                            <p class="text-lg font-bold text-black ">‚Çπ${item.price.toLocaleString()}</p>
                            <button onclick="addToCart(${item.id})" class="mt-2 text-sm bg-black text-white px-4 py-1 rounded hover:bg-gray-800">
                                Add to Cart
                            </button>
                        </div>
                        <button onclick="toggleLike(${item.id})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                `).join('');

                document.getElementById('wishlistContent').innerHTML = wishlistHTML;
            }

            document.getElementById('wishlistModal').style.display = 'block';
        }

        function closeWishlist() {
            document.getElementById('wishlistModal').style.display = 'none';
        }

        // Orders Functions
        function openMyOrders() {
            if (!currentUser) {
                showToast('Please login to view orders', 'error');
                openLoginModal();
                return;
            }

            if (orders.length === 0) {
                document.getElementById('ordersContent').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-shopping-bag text-6xl text-gray-300 mb-4"></i>
                        <p class="text-xl text-secondary">No orders yet</p>
                        <button onclick="closeMyOrders(); scrollToProducts();" class="mt-4 btn-primary">
                            Start Shopping
                        </button>
                    </div>
                `;
            } else {
                const ordersHTML = orders.map(order => {
                    const statusClass = `status-${order.status}`;
                    const statusIcon = order.status === 'delivered' ? 'fa-check-circle' :
                        order.status === 'pending' ? 'fa-clock' :
                            order.status === 'confirmed' ? 'fa-shipping-fast' : 'fa-times-circle';

                    return `
                        <div class="p-4 border-2 rounded-xl mb-4 border-color">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="font-bold text-primary">${order.product.title}</h4>
                                    <p class="text-sm text-secondary">Order ID: ${order.id.toString().substring(0, 15)}...</p>
                                    <p class="text-sm text-secondary">Ordered: ${new Date(order.orderedAt).toLocaleString()}</p>
                                </div>
                                <span class="status-badge ${statusClass}">
                                    <i class="fas ${statusIcon} mr-1"></i>${order.status.toUpperCase()}
                                </span>
                            </div>

                                <img src="${order.product.image}" alt="${order.product.title}" class="w-16 h-16 object-cover rounded">
                                <div class="flex-1">
                                    <p class="text-sm text-secondary">Seller: Verified Seller ‚úì</p>
                                    <p class="text-xs text-secondary">Contact admin for seller details</p>
                                    <p class="text-lg font-bold text-black ">‚Çπ${(order.totalPaid || order.amount || order.product.price).toLocaleString()}</p>
                                </div>
                                ${order.status === 'pending' ? `
                                    <button onclick="markAsDelivered('${order.id}')" class="text-sm bg-black text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition shadow-sm">
                                        Mark Delivered
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('ordersContent').innerHTML = ordersHTML;
            }

            document.getElementById('ordersModal').style.display = 'block';
        }

        function closeMyOrders() {
            document.getElementById('ordersModal').style.display = 'none';
        }

        function markAsDelivered(orderId) {
            const order = orders.find(o => o.id.toString() === orderId);
            if (order) {
                order.status = 'delivered';
                order.deliveredAt = new Date().toISOString();
                localStorage.setItem(`orders_${currentUser.rollNumber}`, JSON.stringify(orders));
                addNotification('Order Delivered', `Your order for ${order.product.title} has been marked as delivered!`);
                openMyOrders(); // Refresh view
                showToast('Order marked as delivered! üéâ', 'success');
            }
        }

        // Notifications
        function loadNotifications() {
            // Sample notifications
            if (currentUser && notifications.length === 0) {
                notifications = [
                    {
                        id: 1,
                        title: 'Welcome!',
                        message: 'Welcome to CampusMart! Start buying and selling today.',
                        time: new Date().toISOString(),
                        read: false
                    },
                    {
                        id: 2,
                        title: 'New Feature',
                        message: 'Dark mode is now available! Toggle it from the navbar.',
                        time: new Date().toISOString(),
                        read: false
                    }
                ];
            }
            updateNotificationBadge();
        }

        function addNotification(title, message) {
            notifications.unshift({
                id: Date.now(),
                title: title,
                message: message,
                time: new Date().toISOString(),
                read: false
            });
            localStorage.setItem(`notifications_${currentUser.rollNumber}`, JSON.stringify(notifications));
            updateNotificationBadge();
        }

        function updateNotificationBadge() {
            const unread = notifications.filter(n => !n.read).length;
            document.getElementById('notificationCount').textContent = unread;
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            const isVisible = panel.classList.contains('show');

            // Close other panels
            document.getElementById('userMenu').classList.remove('show');

            if (isVisible) {
                panel.classList.remove('show');
            } else {
                panel.classList.add('show');
                renderNotifications();
            }
        }

        function renderNotifications() {
            if (notifications.length === 0) {
                document.getElementById('notificationList').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-bell text-4xl text-gray-300 mb-2"></i>
                        <p class="text-secondary">No notifications</p>
                    </div>
                `;
            } else {
                const notificationsHTML = notifications.map(notif => `
                    <div class="notification-item ${notif.read ? '' : 'unread'}" onclick="markNotificationRead(${notif.id})">
                        <h4 class="font-bold text-sm text-primary">${notif.title}</h4>
                        <p class="text-sm text-secondary">${notif.message}</p>
                        <p class="text-xs text-secondary mt-1">${new Date(notif.time).toLocaleTimeString()}</p>
                    </div>
                `).join('');

                document.getElementById('notificationList').innerHTML = notificationsHTML;
            }
        }

        function markNotificationRead(notifId) {
            const notif = notifications.find(n => n.id === notifId);
            if (notif) {
                notif.read = true;
                localStorage.setItem(`notifications_${currentUser.rollNumber}`, JSON.stringify(notifications));
                updateNotificationBadge();
                renderNotifications();
            }
        }

        // User Menu
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            const isVisible = menu.classList.contains('show');

            // Close other panels
            document.getElementById('notificationPanel').classList.remove('show');

            if (isVisible) {
                menu.classList.remove('show');
            } else {
                menu.classList.add('show');
            }
        }

        // Settings
        function openSettings() {
            if (!currentUser) return;

            document.getElementById('settingsName').textContent = currentUser.name;
            document.getElementById('settingsRoll').textContent = currentUser.rollNumber;
            document.getElementById('settingsBranch').textContent = currentUser.branch;
            document.getElementById('settingsYear').textContent = currentUser.year;
            document.getElementById('settingsPhone').textContent = currentUser.phone;
            document.getElementById('settingsRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);

            document.getElementById('userMenu').classList.remove('show');
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function openDashboard() {
            document.getElementById('userMenu').classList.remove('show');
            if (!currentUser) return;

            if (currentUser.role === 'admin') {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            let content = '';
            const users = JSON.parse(localStorage.getItem('campusMartUsers') || '[]');

            if (currentUser.role === 'admin') {
                const pendingOrders = allPlatformOrders.filter(o => o.status === 'pending').length;
                const pendingProducts = products.filter(p => p.status === 'pending').length;
                content = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="stat-card"><div class="text-3xl font-bold text-black ">${users.length}</div><div class="text-secondary">Total Users</div></div>
                        <div class="stat-card"><div class="text-3xl font-bold text-blue-600">${products.length}</div><div class="text-secondary">Products</div></div>
                        <div class="stat-card"><div class="text-3xl font-bold text-green-600">${allPlatformOrders.length}</div><div class="text-secondary">Total Orders</div></div>
                        <div class="stat-card">
                            <div class="text-3xl font-bold ${pendingProducts > 0 ? 'text-red-500' : 'text-gray-400'}">${pendingProducts}</div>
                            <div class="text-secondary">Pending Approval</div>
                        </div>
                    </div>
                    <div class="p-4 bg-green-100 rounded-xl mb-4" style="background: var(--bg-secondary);">
                        <h3 class="font-bold mb-2">üí∞ Platform Earnings</h3>
                        <p>Listing Fees: ‚Çπ${earnings.listingFees} | Service Fees: ‚Çπ${earnings.serviceFees}</p>
                        <p class="text-lg font-bold text-green-600">Total: ‚Çπ${earnings.total}</p>
                    </div>
                    ${pendingProducts > 0 ? `<button onclick="closeDashboard(); openAdminApprovals();" class="w-full bg-orange-500 text-white py-3 rounded-xl font-bold mb-3 animate-pulse">‚≠ê Review ${pendingProducts} New Requests</button>` : ''}
                    <button onclick="closeDashboard(); openAdminOrders();" class="w-full btn-primary">üëë Manage All Orders</button>
                `;
            } else if (currentUser.role === 'seller') {
                const myProducts = products.filter(p => p.sellerRoll === currentUser.rollNumber);
                const myOrders = allPlatformOrders.filter(o => o.seller.roll === currentUser.rollNumber);
                content = `
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="stat-card"><div class="text-3xl font-bold text-black ">${myProducts.length}</div><div class="text-secondary">Products Listed</div></div>
                        <div class="stat-card"><div class="text-3xl font-bold text-green-600">${myOrders.length}</div><div class="text-secondary">Orders Received</div></div>
                    </div>
                    <button onclick="closeDashboard(); openMyProducts();" class="w-full btn-primary mb-3">üè∑Ô∏è My Products</button>
                    <button onclick="closeDashboard(); openSellModal();" class="w-full border-2 border-black text-black  py-3 rounded-xl font-bold">+ List New Product</button>
                `;
            } else {
                content = `
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="stat-card"><div class="text-3xl font-bold text-black ">${cart.length}</div><div class="text-secondary">Cart Items</div></div>
                        <div class="stat-card"><div class="text-3xl font-bold text-blue-600">${orders.length}</div><div class="text-secondary">My Orders</div></div>
                    </div>
                    <button onclick="closeDashboard(); openCart();" class="w-full btn-primary mb-3">üõí View Cart</button>
                    <button onclick="closeDashboard(); openMyOrders();" class="w-full border-2 border-black text-black  py-3 rounded-xl font-bold">üì¶ My Orders</button>
                `;
            }

            document.getElementById('dashboardContent').innerHTML = content;
            document.getElementById('dashboardModal').style.display = 'block';
        }

        function closeDashboard() {
            document.getElementById('dashboardModal').style.display = 'none';
        }

        function openMyProducts() {
            document.getElementById('userMenu').classList.remove('show');
            if (!currentUser) return;

            let content = '';

            if (currentUser.role === 'buyer' || currentUser.role === 'admin') {
                content = `
                    <div class="text-center py-12">
                        <i class="fas fa-store-slash text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">Selling feature restricted</h3>
                        <p class="text-secondary mb-4">${currentUser.role === 'admin' ? 'Admins cannot list products.' : 'Register as a seller to list and sell products.'}</p>
                        ${currentUser.role === 'buyer' ? '<button onclick="closeMyProducts(); logout();" class="btn-primary">Switch to Seller Account</button>' : ''}
                    </div>
                `;
            } else {
                const myProducts = products.filter(p => p.sellerRoll === currentUser.rollNumber);
                if (myProducts.length === 0) {
                    content = `
                        <div class="text-center py-12">
                            <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
                            <h3 class="text-xl font-bold mb-2">No products listed yet</h3>
                            <p class="text-secondary mb-4">Start selling and earn money!</p>
                            <button onclick="closeMyProducts(); openSellModal();" class="btn-primary"><i class="fas fa-plus mr-2"></i>Add Your First Product</button>
                        </div>
                    `;
                } else {
                    content = myProducts.map(p => {
                        const isPending = p.status === 'pending';
                        const statusBadge = isPending ?
                            `<span class="badge bg-yellow-100 text-yellow-800 border border-yellow-300">‚è≥ Waiting for Admin</span>` :
                            `<span class="badge bg-green-100 text-green-800 border border-green-300">‚úÖ Approved</span>`;

                        return `
                        <div class="flex gap-4 p-4 border-b border-color items-center">
                            <img src="${p.image}" class="w-20 h-20 object-cover rounded border">
                            <div class="flex-1">
                                <h4 class="font-bold text-primary">${p.title}</h4>
                                <div class="mb-1">${statusBadge}</div>
                                <p class="text-sm text-secondary">${p.condition} | ${p.category}</p>
                                <p class="text-lg font-bold text-black ">‚Çπ${p.price.toLocaleString()}</p>
                            </div>
                            <div class="flex flex-col gap-2">
                                <!-- Delete Button Removed for Sellers -->
                            </div>
                        </div>
                    `;
                    }).join('');
                }
            }

            document.getElementById('myProductsContent').innerHTML = content;
            document.getElementById('myProductsModal').style.display = 'block';
        }

        function closeMyProducts() {
            document.getElementById('myProductsModal').style.display = 'none';
        }

        function deleteProduct(productId, event) {
            if (event) event.stopPropagation();
            if (!currentUser || currentUser.role !== 'admin') {
                showToast('Only admins can delete products', 'error');
                return;
            }
            if (!confirm('Delete this product?')) return;
            // Safely handle duplicate IDs and loose type matching
            const intId = parseInt(productId);
            const initialLength = products.length;

            // Filter out ALL products with matching ID
            products = products.filter(p => p.id != productId && p.id != intId);

            if (products.length === initialLength) {
                console.warn("Delete failed: Product ID not found", productId);
                showToast('Error: Product not found', 'error');
                return;
            }

            console.log(`Deleted ${initialLength - products.length} products with ID ${productId}`);

            // Save updated products list to storage
            localStorage.setItem('campusMartProducts', JSON.stringify(products));

            // UI Refreshes
            openMyProducts();
            renderProducts();
            renderAdminLanding();
            if (document.getElementById('liveProductsModal').style.display === 'block') {
                renderLiveProductsList();
            }
            showToast('Product deleted', 'info');
        }

        // Admin Order Management
        function openAdminOrders() {
            if (!currentUser || currentUser.role !== 'admin') return;

            if (allPlatformOrders.length === 0) {
                document.getElementById('adminOrdersContent').innerHTML = '<div class="text-center py-12"><i class="fas fa-clipboard-list text-6xl text-gray-300 mb-4"></i><p class="text-secondary">No orders yet</p></div>';
            } else {
                const html = allPlatformOrders.map(o => {
                    const statusText = o.status.replace(/-/g, ' ');
                    let actions = '';
                    if (o.status === 'pending') actions = `<button onclick="updateOrderStatus('${o.id}', 'seller-contacted')" class="text-xs bg-blue-500 text-white px-3 py-1 rounded mr-2">Contact Seller</button><button onclick="updateOrderStatus('${o.id}', 'cancelled')" class="text-xs bg-red-500 text-white px-3 py-1 rounded">Cancel</button>`;
                    else if (o.status === 'seller-contacted') actions = `<button onclick="updateOrderStatus('${o.id}', 'seller-delivered-to-admin')" class="text-xs bg-green-500 text-white px-3 py-1 rounded">Product Received</button>`;
                    else if (o.status === 'seller-delivered-to-admin') actions = `<button onclick="updateOrderStatus('${o.id}', 'buyer-notified')" class="text-xs bg-gray-800 text-white px-3 py-1 rounded">Notify Buyer</button>`;
                    else if (o.status === 'buyer-notified') actions = `<button onclick="updateOrderStatus('${o.id}', 'completed')" class="text-xs bg-green-600 text-white px-3 py-1 rounded">Complete</button>`;

                    return `
                        <div class="p-4 border-2 rounded-xl mb-4 border-color">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold">${o.product.title}</h4>
                                <span class="status-badge status-${o.status}">${statusText}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm mb-2">
                                <div><strong>Buyer:</strong> ${o.buyer.name} (${o.buyer.roll}) - ${o.buyer.phone}</div>
                                <div><strong>Seller:</strong> ${o.seller.name} (${o.seller.roll}) - ${o.seller.phone}</div>
                            </div>
                            <div class="text-sm mb-2"><strong>Price:</strong> ‚Çπ${o.productPrice} + ‚Çπ${o.serviceFee} fee = <strong class="text-black ">‚Çπ${o.totalPaid}</strong> | Seller gets: ‚Çπ${o.sellerPayout}</div>
                            <div>${actions}</div>
                        </div>
                    `;
                }).join('');
                document.getElementById('adminOrdersContent').innerHTML = html;
            }
            document.getElementById('adminOrdersModal').style.display = 'block';
        }

        function closeAdminOrders() {
            document.getElementById('adminOrdersModal').style.display = 'none';
        }

        function updateOrderStatus(orderId, newStatus) {
            const order = allPlatformOrders.find(o => o.id.toString() === orderId.toString());
            if (!order) return;
            order.status = newStatus;
            localStorage.setItem('allPlatformOrders', JSON.stringify(allPlatformOrders));

            // Update buyer's order copy
            const buyerOrders = JSON.parse(localStorage.getItem(`orders_${order.buyer.roll}`) || '[]');
            const bo = buyerOrders.find(o => o.id.toString() === orderId.toString());
            if (bo) { bo.status = newStatus; localStorage.setItem(`orders_${order.buyer.roll}`, JSON.stringify(buyerOrders)); }

            // Notify buyer
            const notifsB = JSON.parse(localStorage.getItem(`notifications_${order.buyer.roll}`) || '[]');
            notifsB.unshift({ id: Date.now(), title: 'Order Update', message: `Your order "${order.product.title}" is now: ${newStatus}`, time: new Date().toISOString(), read: false });
            localStorage.setItem(`notifications_${order.buyer.roll}`, JSON.stringify(notifsB));

            showToast('Order status updated', 'success');
            openAdminOrders();
        }

        // Swap Management Functions
        function openSwaps() {
            if (!currentUser || currentUser.role !== 'admin') return;
            renderSwaps();
            document.getElementById('swapsModal').style.display = 'block';
        }

        function closeSwaps() {
            document.getElementById('swapsModal').style.display = 'none';
        }

        function renderSwaps() {
            const container = document.getElementById('swapsList');
            if (allPlatformOrders.length === 0) {
                container.innerHTML = `<div class="p-12 text-center text-secondary"><i class="fas fa-exchange-alt text-4xl mb-3"></i><p>No swaps recorded yet.</p></div>`;
                return;
            }

            container.innerHTML = allPlatformOrders.map(o => `
                <div class="bg-gray-50 border-2 border-black p-4 rounded-xl flex justify-between items-center">
                    <div class="flex gap-4 items-center">
                         <img src="${o.product.image}" class="w-16 h-16 rounded-lg object-cover border border-gray-200">
                         <div>
                             <h4 class="font-bold text-lg">${o.product.title}</h4>
                             <div class="text-xs text-secondary">
                                 <span class="font-semibold text-black">Buyer:</span> ${o.buyer.name} (${o.buyer.roll}) | 
                                 <span class="font-semibold text-black">Seller:</span> ${o.seller.name} (${o.seller.roll})
                             </div>
                             <div class="text-xs text-green-600 mt-1 font-bold">
                                Completed: ‚Çπ${o.totalPaid}
                             </div>
                         </div>
                    </div>
                    <button onclick="deleteSwap('${o.id}')" class="bg-white border border-red-200 text-red-500 hover:bg-red-500 hover:text-white p-3 rounded-lg transition shadow-sm" title="Delete Record">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
             `).join('');
        }

        function deleteSwap(orderId) {
            if (!confirm('Are you sure you want to delete this swap record? This will remove it from admin records and buyer history.')) return;

            // Find the order first to get buyer details
            const orderToDelete = allPlatformOrders.find(o => o.id.toString() === orderId.toString());

            if (!orderToDelete) {
                showToast('Error: Swap record not found', 'error');
                return;
            }

            // Remove from global list
            allPlatformOrders = allPlatformOrders.filter(o => o.id.toString() !== orderId.toString());
            localStorage.setItem('allPlatformOrders', JSON.stringify(allPlatformOrders));

            // Clean up from Buyer's history
            const buyerRoll = orderToDelete.buyer.roll;
            if (buyerRoll) {
                let buyerOrders = JSON.parse(localStorage.getItem(`orders_${buyerRoll}`) || '[]');
                const initialBuyerLen = buyerOrders.length;
                buyerOrders = buyerOrders.filter(o => o.id.toString() !== orderId.toString());

                if (buyerOrders.length !== initialBuyerLen) {
                    localStorage.setItem(`orders_${buyerRoll}`, JSON.stringify(buyerOrders));
                }
            }

            showToast('Swap record deleted', 'success');
            renderSwaps();
            renderAdminLanding(); // Update counter
        }

        // Pending Swaps Functions
        function openPendingSwaps() {
            if (!currentUser || currentUser.role !== 'admin') return;
            renderPendingSwaps();
            document.getElementById('pendingSwapsModal').style.display = 'block';
        }

        function closePendingSwaps() {
            document.getElementById('pendingSwapsModal').style.display = 'none';
        }

        function renderPendingSwaps() {
            const container = document.getElementById('pendingSwapsList');
            const pending = allPlatformOrders.filter(o => o.status !== 'completed' && o.status !== 'cancelled');

            if (pending.length === 0) {
                container.innerHTML = `<div class="p-12 text-center text-secondary"><i class="fas fa-clock text-4xl mb-3"></i><p>No pending swaps found.</p></div>`;
                return;
            }

            container.innerHTML = pending.map(o => `
                <div class="bg-orange-50 border-2 border-orange-200 p-4 rounded-xl flex justify-between items-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-orange-400"></div>
                    <div class="flex gap-4 items-center">
                         <img src="${o.product.image}" class="w-16 h-16 rounded-lg object-cover border border-orange-200 bg-white">
                         <div>
                             <h4 class="font-bold text-lg text-primary">${o.product.title}</h4>
                             <div class="grid grid-cols-2 gap-x-6 gap-y-1 text-sm mt-1">
                                 <div>
                                     <span class="font-bold text-black uppercase text-xs">Buyer</span><br>
                                     ${o.buyer.name}<br>
                                     <span class="text-orange-700 font-mono"><i class="fas fa-phone-alt text-xs mr-1"></i>${o.buyer.phone}</span>
                                 </div>
                                 <div>
                                     <span class="font-bold text-black uppercase text-xs">Seller</span><br>
                                     ${o.seller.name}<br>
                                     <span class="text-orange-700 font-mono"><i class="fas fa-phone-alt text-xs mr-1"></i>${o.seller.phone}</span>
                                 </div>
                             </div>
                             <div class="mt-2 text-xs font-bold uppercase tracking-wider text-orange-600 bg-orange-100 px-2 py-1 rounded inline-block">
                                Status: ${o.status.replace(/-/g, ' ')}
                             </div>
                         </div>
                    </div>
                </div>
             `).join('');
        }

        // Community Details Functions
        function openCommunityDetails() {
            if (!currentUser || currentUser.role !== 'admin') return;
            renderCommunityTable();
            document.getElementById('communityModal').style.display = 'block';
        }

        function closeCommunityDetails() {
            document.getElementById('communityModal').style.display = 'none';
        }

        function renderCommunityTable() {
            const users = JSON.parse(localStorage.getItem('campusMartUsers') || '[]');
            const tableBody = document.getElementById('communityTableBody');

            if (users.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="p-12 text-center text-secondary"><i class="fas fa-users-slash text-4xl mb-3"></i><p>No community members found.</p></td></tr>`;
                return;
            }

            tableBody.innerHTML = users.map(user => {
                const date = new Date(user.registeredAt || Date.now()).toLocaleDateString('en-IN', {
                    day: 'numeric', month: 'short', year: 'numeric'
                });

                const roleColor = user.role === 'admin' ? 'text-purple-600 bg-purple-50' :
                    user.role === 'seller' ? 'text-blue-600 bg-blue-50' : 'text-green-600 bg-green-50';

                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=random" class="w-10 h-10 rounded-full border">
                                <div>
                                    <div class="font-bold text-primary">${user.name}</div>
                                    <div class="text-xs text-secondary">Roll: ${user.rollNumber}</div>
                                </div>
                            </div>
                        </td>
                        <td class="p-4">
                            <div class="text-sm font-semibold"><i class="fas fa-phone mr-2 text-gray-400"></i>${user.phone}</div>
                            <div class="text-xs text-secondary mt-1"><i class="fas fa-envelope mr-2 text-gray-400"></i>${user.email}</div>
                        </td>
                        <td class="p-4">
                            <div class="text-sm">${user.branch}</div>
                            <div class="text-xs text-secondary">${user.year} Year</div>
                        </td>
                        <td class="p-4">
                            <span class="px-3 py-1 rounded-full text-xs font-black uppercase ${roleColor}">${user.role}</span>
                        </td>
                        <td class="p-4 text-sm text-secondary">
                            ${date}
                        </td>
                        <td class="p-4">
                            ${user.rollNumber !== currentUser.rollNumber ? `
                                <button onclick="deleteUser('${user.rollNumber}')" class="text-red-500 hover:text-red-700 transition-colors p-2 rounded-lg hover:bg-red-50" title="Delete User">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            ` : '<span class="text-gray-300 text-xs italic">You</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function deleteUser(rollNumber) {
            if (!confirm('Are you sure you want to remove this user from the community? This action cannot be undone.')) return;

            let users = JSON.parse(localStorage.getItem('campusMartUsers') || '[]');
            const userToDelete = users.find(u => u.rollNumber === rollNumber);

            if (!userToDelete) {
                showToast('User not found', 'error');
                return;
            }

            if (userToDelete.rollNumber === currentUser.rollNumber) {
                showToast('You cannot delete your own admin account', 'error');
                return;
            }

            users = users.filter(u => u.rollNumber !== rollNumber);
            localStorage.setItem('campusMartUsers', JSON.stringify(users));

            showToast(`User ${userToDelete.name} removed successfully`, 'success');
            renderCommunityTable();
            renderAdminLanding(); // Update the count on the dashboard
        }

        // Live Products Management Functions
        function openLiveProducts() {
            if (!currentUser || currentUser.role !== 'admin') return;
            renderLiveProductsList();
            document.getElementById('liveProductsModal').style.display = 'block';
        }

        function closeLiveProducts() {
            document.getElementById('liveProductsModal').style.display = 'none';
        }

        function renderLiveProductsList() {
            const container = document.getElementById('liveProductsContent');
            const approvedProducts = products.filter(p => p.status === 'approved');

            if (approvedProducts.length === 0) {
                container.innerHTML = `<div class="col-span-full p-12 text-center text-secondary"><i class="fas fa-box-open text-4xl mb-3"></i><p>No live products found.</p></div>`;
                return;
            }

            container.innerHTML = approvedProducts.map(p => `
                <div class="bg-gray-50 border-2 border-black p-4 rounded-2xl">
                    <div class="flex gap-4 items-start mb-3">
                        <img src="${p.image}" class="w-24 h-24 object-cover rounded-xl border border-black shadow-sm">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-primary truncate">${p.title}</h4>
                            <p class="text-xs text-secondary truncate">By ${p.seller} (${p.sellerRoll})</p>
                            <div class="font-black text-lg">‚Çπ${p.price.toLocaleString()}</div>
                        </div>
                        <button onclick="deleteProduct(${p.id}, event)" class="bg-red-50 text-red-500 p-3 rounded-xl hover:bg-red-500 hover:text-white transition-all shadow-sm border border-red-100">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div class="border-t pt-3 grid grid-cols-2 gap-2 text-xs">
                        <div><span class="font-bold text-gray-600">Category:</span> <span class="capitalize">${p.category || 'N/A'}</span></div>
                        <div><span class="font-bold text-gray-600">Condition:</span> ${p.condition || 'N/A'}</div>
                        <div><span class="font-bold text-gray-600">Quantity:</span> ${p.quantity || 1}</div>
                        <div><span class="font-bold text-gray-600">Location:</span> ${p.location || 'Campus'}</div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500 line-clamp-2">
                        <span class="font-bold">Description:</span> ${p.description || 'No description available'}
                    </div>
                    <div class="mt-2 text-xs">
                        <span class="font-bold text-gray-600">Seller Phone:</span> ${p.sellerPhone || 'N/A'}
                    </div>
                </div>
            `).join('');
        }

        function openAdminApprovals() {
            const pending = products.filter(p => p.status === 'pending');
            const list = document.getElementById('adminApprovalsList');

            if (pending.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-check-circle text-6xl text-green-500 mb-4 opacity-20"></i>
                        <p class="text-xl text-secondary">All caught up! No pending requests.</p>
                    </div>
                `;
            } else {
                list.innerHTML = pending.map(p => `
                    <div class="p-4 border-2 rounded-xl mb-4 border-color bg-gray-50">
                        <div class="flex gap-4">
                            <img src="${p.image}" class="w-32 h-32 object-cover rounded-xl border-2 border-black bg-white">
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <h3 class="text-xl font-bold text-primary">${p.title}</h3>
                                    <span class="text-lg font-bold">‚Çπ${p.price.toLocaleString()}</span>
                                </div>
                                <p class="text-sm text-secondary mb-2 line-clamp-2">${p.description}</p>
                                <div class="grid grid-cols-2 gap-2 text-sm mb-4">
                                    <div><strong>Seller:</strong> ${p.seller} (${p.sellerRoll})</div>
                                    <div><strong>Location:</strong> ${p.location}</div>
                                    <div><strong>Category:</strong> ${p.category}</div>
                                    <div><strong>Condition:</strong> ${p.condition}</div>
                                </div>
                                <div class="flex gap-3">
                                    <button onclick="openFeeApprovalModal(${p.id}, ${p.price})" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700 transition">
                                        <i class="fas fa-check mr-2"></i> Approve
                                    </button>
                                    <button onclick="rejectProduct(${p.id})" class="flex-1 bg-red-100 text-red-600 py-2 rounded-lg font-bold hover:bg-red-200 transition">
                                        <i class="fas fa-times mr-2"></i> Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            document.getElementById('adminApprovalsModal').style.display = 'block';
        }

        function closeAdminApprovals() {
            document.getElementById('adminApprovalsModal').style.display = 'none';
        }

        // Fee Approval Logic
        let currentApproveId = null;

        function openFeeApprovalModal(id, price) {
            currentApproveId = id;

            // Calculate default service fee for convenience
            const defaultService = calculateServiceFee(price);

            document.getElementById('feeListing').value = 0;
            document.getElementById('feeService').value = defaultService;
            document.getElementById('feePlatform').value = 0;

            updateFeeTotals();
            document.getElementById('approveFeeModal').style.display = 'block';
        }

        function closeFeeModal() {
            document.getElementById('approveFeeModal').style.display = 'none';
            currentApproveId = null;
        }

        function updateFeeTotals() {
            const listing = parseInt(document.getElementById('feeListing').value) || 0;
            const service = parseInt(document.getElementById('feeService').value) || 0;
            const platform = parseInt(document.getElementById('feePlatform').value) || 0;

            document.getElementById('feeTotal').textContent = '‚Çπ' + (listing + service + platform).toLocaleString();
        }

        function confirmApprovalWithFees() {
            if (!currentApproveId) return;

            const listingRef = parseInt(document.getElementById('feeListing').value) || 0;
            const serviceRef = parseInt(document.getElementById('feeService').value) || 0;
            const platformRef = parseInt(document.getElementById('feePlatform').value) || 0;

            approveProduct(currentApproveId, { listingRef, serviceRef, platformRef });
            closeFeeModal();
        }

        function approveProduct(productId, fees = null) {
            const product = products.find(p => p.id === productId);
            if (product) {
                product.status = 'approved';
                product.verified = true;

                // Save Admin Fees on the product object
                if (fees) {
                    product.adminListingFee = fees.listingRef;
                    product.adminServiceFee = fees.serviceRef;
                    product.adminPlatformCharge = fees.platformRef;
                }

                // Update in storage
                localStorage.setItem('campusMartProducts', JSON.stringify(products));

                showToast('Product approved! It is now live üöÄ', 'success');
                openAdminApprovals(); // Refresh list
                renderProducts(); // Refresh grid
            }
        }

        function rejectProduct(productId) {
            if (confirm('Are you sure you want to reject this product? It will be deleted.')) {
                deleteProduct(productId);
                openAdminApprovals(); // Refresh list
            }
        }

        // Product Rendering
        function renderProducts(category = 'all') {
            const container = document.getElementById('products-container');
            // Filter out pending products (unless viewer is admin/seller looking at their own, but main grid is for buyers)
            let filtered = category === 'all' ? products : products.filter(p => p.category === category);

            // Only show approved products in the main grid
            filtered = filtered.filter(p => p.status !== 'pending');

            container.innerHTML = filtered.map(product => {
                const isInWishlist = wishlist.find(item => item.id === product.id);
                // Added fa-heart
                const heartClass = isInWishlist ? 'fas fa-heart text-red-500' : 'far fa-heart text-gray-600';

                // Variables must be declared before return
                const priceDisplay = `‚Çπ${product.price.toLocaleString()}`;
                const quantityBadge = product.quantity && product.quantity > 1 ? `<span class="badge bg-gray-200 text-gray-700 ml-2">${product.quantity} left</span>` : '';

                // Admin Delete Button
                const deleteBtn = (currentUser && currentUser.role === 'admin') ?
                    `<button onclick="deleteProduct(${product.id}, event)" class="absolute top-2 right-12 z-10 bg-white p-2 text-red-500 rounded-full shadow-md hover:bg-red-50"><i class="fas fa-trash"></i></button>` : '';

                // Buy/Cart Buttons (Hidden for Admin/Seller)
                const actionButtons = (currentUser && (currentUser.role === 'admin' || currentUser.role === 'seller')) ?
                    '' :
                    `<button onclick="addToCart(${product.id}, event)" class="w-full bg-black text-white py-2 rounded-xl hover:bg-gray-800 transition    ">
                        <i class="fas fa-shopping-cart mr-2"></i> Add to Cart
                    </button>`;

                return `
                    <div class="card rounded-xl overflow-hidden cursor-pointer" onclick="showProductDetail(${product.id})">
                        <div class="relative">
                            <img src="${product.image}" alt="${product.title}" class="product-img">
                            ${product.eco ? '<span class="absolute top-2 left-2 badge bg-green-500 text-white">‚ôªÔ∏è Eco</span>' : ''}
                            ${deleteBtn}
                            ${product.condition === 'New' ? '<span class="absolute top-2 right-2 badge bg-blue-500 text-white">NEW</span>' : ''}
                            <button onclick="toggleLike(${product.id}, event)" class="absolute bottom-2 right-2 bg-white p-2 rounded-full shadow-md hover:scale-110 transition">
                                <i class="${heartClass} text-xl"></i>
                            </button>
                        </div>

                        <div class="p-4">
                            <h3 class="font-bold text-lg mb-2 line-clamp-2 text-primary">${product.title}</h3>

                            <div class="flex items-center gap-2 mb-3">
                                <img src="${product.sellerAvatar}" class="w-6 h-6 rounded-full">
                                <span class="text-sm text-secondary">${product.seller}</span>
                                ${product.verified ? '<span class="text-blue-500 text-sm">‚úì</span>' : ''}
                            </div>

                            <div class="flex items-center gap-2 text-sm text-secondary mb-3">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${product.location}</span>
                            </div>

                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <span class="text-2xl font-bold text-black ">${priceDisplay}</span>
                                    ${quantityBadge}
                                    ${product.originalPrice ? `<div class="text-xs text-gray-500 line-through">‚Çπ${product.originalPrice.toLocaleString()}</div>` : ''}
                                </div>
                                <div class="flex items-center gap-1">
                                    <i class="fas fa-star text-yellow-500 text-sm"></i>
                                    <span class="font-semibold text-sm">${product.rating}</span>
                                </div>
                            </div>

                            ${actionButtons}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterCategory(category, event) {
            currentCategory = category;
            document.querySelectorAll('.category-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            event.target.classList.add('active');
            renderProducts(category);
        }

        function searchProducts() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const container = document.getElementById('products-container');

            const filtered = products.filter(p =>
                (p.title && p.title.toLowerCase().includes(query)) ||
                (p.seller && p.seller.toLowerCase().includes(query)) ||
                (p.category && p.category.toLowerCase().includes(query))
            );

            if (filtered.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-12 text-secondary"><i class="fas fa-search text-4xl mb-4"></i><p class="text-xl">No products found</p></div>';
            } else {
                currentCategory = 'all';
                container.innerHTML = filtered.map(product => {
                    const isInWishlist = wishlist.find(item => item.id === product.id);
                    const heartClass = isInWishlist ? 'fas fa-heart text-red-500' : 'far fa-heart text-gray-600';

                    const priceDisplay = `‚Çπ${product.price.toLocaleString()}`;
                    const quantityBadge = product.quantity && product.quantity > 1 ? `<span class="badge bg-gray-200 text-gray-700 ml-2">${product.quantity} left</span>` : '';

                    // Admin Delete Button
                    const deleteBtn = (currentUser && currentUser.role === 'admin') ?
                        `<button onclick="deleteProduct(${product.id}, event)" class="absolute top-2 right-12 z-10 bg-white p-2 text-red-500 rounded-full shadow-md hover:bg-red-50"><i class="fas fa-trash"></i></button>` : '';

                    // Buy/Cart Buttons (Hidden for Admin/Seller)
                    const actionButtons = (currentUser && (currentUser.role === 'admin' || currentUser.role === 'seller')) ?
                        '' :
                        `<button onclick="addToCart(${product.id}, event)" class="w-full bg-black text-white py-2 rounded-xl hover:bg-gray-800 transition    ">
                        <i class="fas fa-shopping-cart mr-2"></i> Add to Cart
                    </button>`;

                    return `
                    <div class="card rounded-xl overflow-hidden cursor-pointer" onclick="showProductDetail(${product.id})">
                        <div class="relative">
                            <img src="${product.image}" alt="${product.title}" class="product-img">
                            ${product.eco ? '<span class="absolute top-2 left-2 badge bg-green-500 text-white">‚ôªÔ∏è Eco</span>' : ''}
                            ${deleteBtn}
                            ${product.condition === 'New' ? '<span class="absolute top-2 right-2 badge bg-blue-500 text-white">NEW</span>' : ''}
                            <button onclick="toggleLike(${product.id}, event)" class="absolute bottom-2 right-2 bg-white p-2 rounded-full shadow-md hover:scale-110 transition">
                                <i class="${heartClass} text-xl"></i>
                            </button>
                        </div>

                        <div class="p-4">
                            <h3 class="font-bold text-lg mb-2 line-clamp-2 text-primary">${product.title}</h3>

                            <div class="flex items-center gap-2 mb-3">
                                <img src="${product.sellerAvatar}" class="w-6 h-6 rounded-full">
                                <span class="text-sm text-secondary">${product.seller}</span>
                                ${product.verified ? '<span class="text-blue-500 text-sm">‚úì</span>' : ''}
                            </div>

                            <div class="flex items-center gap-2 text-sm text-secondary mb-3">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${product.location}</span>
                            </div>

                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <span class="text-2xl font-bold text-black ">${priceDisplay}</span>
                                    ${quantityBadge}
                                    ${product.originalPrice ? `<div class="text-xs text-gray-500 line-through">‚Çπ${product.originalPrice.toLocaleString()}</div>` : ''}
                                </div>
                                <div class="flex items-center gap-1">
                                    <i class="fas fa-star text-yellow-500 text-sm"></i>
                                    <span class="font-semibold text-sm">${product.rating}</span>
                                </div>
                            </div>

                            ${actionButtons}
                        </div>
                    </div>
                `;
                }).join('');
            }
        }

        // Search Suggestions
        function handleSearchInput(query) {
            // Filter main grid
            searchProducts();

            const suggestionsBox = document.getElementById('searchSuggestions');
            if (!query) {
                suggestionsBox.classList.add('hidden');
                return;
            }

            const matches = products.filter(p =>
                p.title.toLowerCase().includes(query.toLowerCase()) ||
                p.category.toLowerCase().includes(query.toLowerCase())
            );

            if (matches.length > 0) {
                suggestionsBox.innerHTML = matches.map(product => {
                    // Highlight match in title
                    const regex = new RegExp(`(${query})`, 'gi');
                    const highlightedTitle = product.title.replace(regex, '<span class="font-bold text-black ">$1</span>');

                    return `
                    <div class="p-3 hover:bg-gray-100  cursor-pointer flex items-center gap-3 border-b border-gray-100  last:border-0"
                         onclick="selectSuggestion('${product.title.replace(/'/g, "\\'")}')">
                        <img src="${product.image}" class="w-10 h-10 rounded object-cover">
                        <div>
                            <div class="text-sm text-primary">${highlightedTitle}</div>
                            <div class="text-xs text-secondary">${product.category}</div>
                        </div>
                    </div>
                `}).join('');
                suggestionsBox.classList.remove('hidden');
            } else {
                suggestionsBox.innerHTML = `
                    <div class="p-3 text-sm text-secondary text-center">No matches found</div>
                `;
                suggestionsBox.classList.remove('hidden');
            }
        }

        function selectSuggestion(title) {
            document.getElementById('searchInput').value = title;
            document.getElementById('searchSuggestions').classList.add('hidden');
            searchProducts(); // Trigger main search with full title
        }

        // Close suggestions on outside click
        document.addEventListener('click', function (e) {
            const searchContainer = document.querySelector('.relative.w-full');
            const suggestionsBox = document.getElementById('searchSuggestions');
            if (suggestionsBox && searchContainer && !searchContainer.contains(e.target)) {
                suggestionsBox.classList.add('hidden');
            }
        });

        // Sell Product
        function openSellModal() {
            if (!currentUser) {
                showToast('Please login to sell products', 'error');
                openLoginModal();
                return;
            }
            if (currentUser.role === 'buyer' || currentUser.role === 'admin') {
                showToast('Only sellers can list products.', 'error');
                return;
            }
            document.getElementById('sellModal').style.display = 'block';
        }

        function closeSellModal() {
            document.getElementById('sellModal').style.display = 'none';
        }

        function handleSellProduct(event) {
            event.preventDefault();

            const productTitle = document.getElementById('productTitle').value;
            const productDescription = document.getElementById('productDescription').value;

            // Validate product name and description
            if (!validateProductName(productTitle)) {
                showToast('Product title must contain at least 3 alphabetic characters', 'error');
                return;
            }
            if (!validateProductDescription(productDescription)) {
                showToast('Description must contain at least 3 alphabetic characters', 'error');
                return;
            }

            const productData = {
                id: Date.now(),
                title: productTitle,
                category: document.getElementById('productCategory').value,
                condition: document.getElementById('productCondition').value,
                price: parseInt(document.getElementById('productPrice').value),
                quantity: parseInt(document.getElementById('productQuantity').value) || 1,
                originalPrice: parseInt(document.getElementById('productOriginalPrice').value) || null,
                description: productDescription,
                location: document.getElementById('productLocation').value || 'Campus',
                seller: currentUser.name,
                sellerPhone: currentUser.phone,
                sellerRoll: currentUser.rollNumber,
                sellerAvatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=667eea&color=fff`,
                rating: 0,
                verified: true,
                eco: false,
                status: 'pending',
                image: lastUploadedImages[0] || "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=400",
                images: [...lastUploadedImages]
            };

            products.push(productData);

            // Update storage with all products
            localStorage.setItem('campusMartProducts', JSON.stringify(products));

            closeSellModal();
            showToast('Product listed! Waiting for admin approval ‚è≥', 'success');
            renderProducts();

            document.getElementById('sellForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
        }

        function previewImages(event) {
            const files = Array.from(event.target.files);
            const preview = document.getElementById('imagePreview');

            if (files.length === 0) return;

            if (files.length > 5) {
                showToast('Maximum 5 images allowed', 'error');
                event.target.value = '';
                return;
            }

            lastUploadedImages = [];
            preview.innerHTML = '';

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    lastUploadedImages.push(e.target.result);
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }

        // Utility Functions
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };

            toast.innerHTML = `<i class="fas ${icons[type]} mr-2"></i> ${message}`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function scrollToProducts() {
            document.getElementById('productsSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Modal Functions
        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function openRegisterModal() {
            document.getElementById('registerModal').style.display = 'block';
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').style.display = 'none';
        }

        // How It Works Modal
        function openHowItWorksModal() {
            document.getElementById('howItWorksModal').style.display = 'block';
        }

        function closeHowItWorksModal() {
            document.getElementById('howItWorksModal').style.display = 'none';
        }

        // Safety Tips Modal
        function openSafetyTipsModal() {
            document.getElementById('safetyTipsModal').style.display = 'block';
        }

        function closeSafetyTipsModal() {
            document.getElementById('safetyTipsModal').style.display = 'none';
        }

        // Scroll to Home (for About Us link)
        function scrollToHome() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Filter products from footer category links
        function filterFromFooter(category) {
            // Scroll to products section first
            document.getElementById('productsSection').scrollIntoView({ behavior: 'smooth' });

            // Update category chips UI
            document.querySelectorAll('.category-chip').forEach(chip => {
                chip.classList.remove('active');
                if (chip.textContent.toLowerCase().includes(category.toLowerCase()) ||
                    (category === 'books' && chip.textContent.toLowerCase().includes('books'))) {
                    chip.classList.add('active');
                }
            });

            // Set current category and render
            currentCategory = category;
            renderProducts(category);
        }

        // Close modals on outside click
        window.onclick = function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }

            // Close dropdowns when clicking outside
            if (!event.target.closest('#userMenu') && !event.target.closest('.cursor-pointer')) {
                document.getElementById('userMenu').classList.remove('show');
                document.getElementById('notificationPanel').classList.remove('show');
            }

            if (event.target.id === 'adminApprovalsModal') {
                closeAdminApprovals();
            }
        }

        // ===== NEW PHASE 2 FUNCTIONS =====

        // Logo click counter for secret admin access
        let logoClickCount = 0;
        let logoClickTimer = null;
        function handleLogoClick() {
            logoClickCount++;
            if (logoClickTimer) clearTimeout(logoClickTimer);
            logoClickTimer = setTimeout(() => { logoClickCount = 0; }, 2000);
            if (logoClickCount >= 5) {
                logoClickCount = 0;
                openAdminLogin();
            }
        }

        // Admin Login Functions
        const ADMIN_PASSWORD = 'Admin@123';
        function openAdminLogin() {
            document.getElementById('adminLoginModal').style.display = 'block';
        }
        function closeAdminLogin() {
            document.getElementById('adminLoginModal').style.display = 'none';
            document.getElementById('adminSecretCode').value = '';
            document.getElementById('adminPassword').value = '';
        }
        function handleAdminLogin(e) {
            e.preventDefault();
            const secret = document.getElementById('adminSecretCode').value;
            const pass = document.getElementById('adminPassword').value;
            if (secret !== ADMIN_SECRET) { showToast('Invalid secret code', 'error'); return; }
            if (pass !== ADMIN_PASSWORD) { showToast('Invalid admin password', 'error'); return; }
            currentUser = { name: 'Admin', role: 'admin', rollNumber: 'ADMIN001', phone: '0000000000' };
            localStorage.setItem('campusMartUser', JSON.stringify(currentUser));
            loadUserData();
            updateUIForLoggedInUser();
            closeAdminLogin();
            showToast('Welcome Admin! üëë', 'success');
        }

        // Forgot Password Functions
        let forgotUserData = null;
        function openForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'block';
            document.getElementById('forgotStep1').style.display = 'block';
            document.getElementById('forgotStep2').style.display = 'none';
        }
        function closeForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'none';
            forgotUserData = null;
        }
        function verifyForgotPassword() {
            const roll = document.getElementById('forgotRoll').value.trim();
            const phone = document.getElementById('forgotPhone').value.trim();
            if (!roll || !phone) { showToast('Enter both roll and phone', 'error'); return; }
            const users = JSON.parse(localStorage.getItem('campusMartUsers') || '[]');
            const user = users.find(u => u.rollNumber === roll && u.phone === phone);
            if (!user) { showToast('No matching account found', 'error'); return; }
            forgotUserData = user;
            document.getElementById('forgotStep1').style.display = 'none';
            document.getElementById('forgotStep2').style.display = 'block';
            showToast('Verified! Set new password', 'success');
        }
        function resetPassword() {
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmNewPassword').value;
            if (!validatePassword(newPass)) { showToast('Password must be 8-16 chars, 1 upper, 1 lower, 1 number, start with letter', 'error'); return; }
            if (newPass !== confirm) { showToast('Passwords do not match', 'error'); return; }
            const users = JSON.parse(localStorage.getItem('campusMartUsers') || '[]');
            const idx = users.findIndex(u => u.rollNumber === forgotUserData.rollNumber && u.role === forgotUserData.role);
            if (idx > -1) { users[idx].password = newPass; localStorage.setItem('campusMartUsers', JSON.stringify(users)); }
            closeForgotPassword();
            showToast('Password reset successful! üéâ', 'success');
        }

        // Payment Functions
        let pendingPayment = null;
        let selectedPaymentMethod = null;
        function showPaymentModal(cartItems, total) {
            pendingPayment = { items: cartItems, total: total };
            const serviceFee = cartItems.reduce((sum, i) => sum + ((i.adminServiceFee !== undefined) ? i.adminServiceFee : calculateServiceFee(i.price)), 0);
            const platformCharge = cartItems.reduce((sum, i) => sum + ((i.adminPlatformCharge !== undefined) ? i.adminPlatformCharge : 0), 0);

            const grandTotal = total + serviceFee + platformCharge;
            document.getElementById('paymentDetails').innerHTML = `
                <div class="flex justify-between"><span>Subtotal:</span><span>‚Çπ${total}</span></div>
                <div class="flex justify-between"><span>Service Fee:</span><span>‚Çπ${serviceFee}</span></div>
                ${platformCharge > 0 ? `<div class="flex justify-between text-orange-600"><span>Platform Charge:</span><span>‚Çπ${platformCharge}</span></div>` : ''}
                <div class="flex justify-between font-bold text-lg mt-2 pt-2 border-t"><span class="text-secondary">Payable Total:</span><span class="text-black ">‚Çπ${grandTotal}</span></div>
            `;
            pendingPayment.grandTotal = grandTotal;
            pendingPayment.serviceFee = serviceFee;
            document.getElementById('paymentModal').style.display = 'block';
            selectedPaymentMethod = null;
            document.getElementById('confirmPayBtn').disabled = true;
            document.getElementById('upiQRSection').style.display = 'none';
            document.getElementById('codBtn').classList.remove('border-black', 'bg-gray-100');
            document.getElementById('upiBtn').classList.remove('border-black', 'bg-gray-100');
        }
        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            pendingPayment = null;
        }
        function selectPayment(method) {
            selectedPaymentMethod = method;
            document.getElementById('confirmPayBtn').disabled = false;
            document.getElementById('codBtn').classList.remove('border-black', 'bg-gray-100');
            document.getElementById('upiBtn').classList.remove('border-black', 'bg-gray-100');
            if (method === 'COD') {
                document.getElementById('codBtn').classList.add('border-black', 'bg-gray-100');
                document.getElementById('upiQRSection').style.display = 'none';
            } else {
                document.getElementById('upiBtn').classList.add('border-black', 'bg-gray-100');
                document.getElementById('upiQRSection').style.display = 'block';
            }
        }
        function confirmPayment() {
            try {
                if (!selectedPaymentMethod || !pendingPayment) {
                    console.error('Missing payment info', { selectedPaymentMethod, pendingPayment });
                    showToast('Payment Method or Details Missing', 'error');
                    return;
                }

                // Capture data before closing modal (which wipes pendingPayment)
                const paymentData = pendingPayment;
                const method = selectedPaymentMethod;

                closePaymentModal();
                closeCart();

                console.log('Confirming payment...', method);
                finalizeCheckout(paymentData, method);
            } catch (e) {
                console.error('Payment Error:', e);
                alert('Payment Error: ' + e.message);
            }
        }

        // Validation Functions
        function validatePassword(pass) {
            // Min 6 chars
            return pass.length >= 6;
        }
        function validateName(name) {
            // Must contain at least 3 alphabetic characters (excluding spaces), max 20 total
            const alphaOnly = name.replace(/\s/g, '');
            return /^[a-zA-Z\s]{1,20}$/.test(name) && /^[a-zA-Z]+$/.test(alphaOnly) && alphaOnly.length >= 3;
        }
        function validateRollNumber(roll) {
            // Must contain at least 1 alphabet, at least 1 number, and no spaces
            const hasAlpha = /[a-zA-Z]/.test(roll);
            const hasNumber = /[0-9]/.test(roll);
            const hasNoSpaces = !/\s/.test(roll);
            return hasAlpha && hasNumber && hasNoSpaces;
        }
        function validateProductName(name) {
            // Must contain at least 3 alphabetic characters (excluding spaces)
            const alphaOnly = name.replace(/[^a-zA-Z]/g, '');
            return alphaOnly.length >= 3;
        }
        function validateProductDescription(desc) {
            // Must contain at least 3 alphabetic characters (excluding spaces)
            const alphaOnly = desc.replace(/[^a-zA-Z]/g, '');
            return alphaOnly.length >= 3;
        }
        function validatePhone(phone) {
            // Numbers only, 10 digits
            return /^[0-9]{10}$/.test(phone);
        }

        // Toggle Password Visibility
        function togglePassword(inputId, icon) {
            const input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            } else {
                input.type = "password";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            }
        }

        // Role-based UI helpers
        function canBuy() { return currentUser && currentUser.role === 'buyer'; }
        function canSell() { return currentUser && currentUser.role === 'seller'; }

        // Seller Accept Order
        function sellerAcceptOrder(orderId) {
            const order = allPlatformOrders.find(o => o.id.toString() === orderId.toString());
            if (!order) return;
            order.sellerAccepted = true;
            order.status = 'seller-contacted';
            localStorage.setItem('allPlatformOrders', JSON.stringify(allPlatformOrders));

            // Notify admin
            const users = JSON.parse(localStorage.getItem('campusMartUsers') || '[]');
            users.filter(u => u.role === 'admin').forEach(admin => {
                const an = JSON.parse(localStorage.getItem(`notifications_${admin.rollNumber}`) || '[]');
                an.unshift({ id: Date.now(), title: '‚úÖ Seller Accepted', message: `Seller accepted "${order.product.title}"`, time: new Date().toISOString(), read: false });
                localStorage.setItem(`notifications_${admin.rollNumber}`, JSON.stringify(an));
            });

            // Notify buyer
            const bn = JSON.parse(localStorage.getItem(`notifications_${order.buyer.roll}`) || '[]');
            bn.unshift({ id: Date.now(), title: 'üì¶ Order Accepted', message: `Seller accepted your order for "${order.product.title}"`, time: new Date().toISOString(), read: false });
            localStorage.setItem(`notifications_${order.buyer.roll}`, JSON.stringify(bn));

            showToast('Order accepted! üéâ', 'success');
            renderNotifications();
        }

        // Seller: Send cart to buyer account
        function sendCartToBuyer() {
            if (!currentUser || currentUser.role !== 'seller') return;
            const buyerCart = JSON.parse(localStorage.getItem(`cart_${currentUser.rollNumber}_buyer`) || '[]');
            const merged = [...buyerCart, ...cart];
            localStorage.setItem(`cart_${currentUser.rollNumber}_buyer`, JSON.stringify(merged));
            cart = [];
            localStorage.setItem(`cart_${currentUser.rollNumber}`, JSON.stringify(cart));
            updateCartBadge();
            showToast('Cart sent to your buyer account!', 'success');
            closeCart();
        }

        // Notification click handler
        function handleNotificationClick(notif) {
            if (notif.type === 'seller-accept' && currentUser.role === 'seller') {
                sellerAcceptOrder(notif.orderId);
            } else if (notif.title.includes('Order')) {
                openMyOrders();
            }
            markNotificationRead(notif.id);
        }
    </script>
</body>

</html>